name: BOJ Study Automation

on:
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 */2 * * *'  # 2ì‹œê°„ë§ˆë‹¤ ë°ë“œë¼ì¸ ì²´í¬

jobs:
  test-and-merge:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '11'
    
    - name: Install dependencies
      run: |
        pip install requests beautifulsoup4 google-generativeai pytz
    
    - name: Extract problem and code info
      id: extract-info
      run: |
        python scripts/extract_pr_info.py
      env:
        PR_NUMBER: ${{ github.event.pull_request.number }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Get problem details from BOJ
      id: problem-details
      run: |
        python scripts/fetch_boj_problem.py \
          --problem-id ${{ steps.extract-info.outputs.problem_id }}
    
    - name: Generate test cases with Gemini
      id: generate-tests
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        python scripts/gemini_test_generator.py \
          --problem-id ${{ steps.extract-info.outputs.problem_id }} \
          --code-file ${{ steps.extract-info.outputs.code_file }} \
          --language ${{ steps.extract-info.outputs.language }} \
          --problem-info problem_info.json
    
    - name: Run all tests
      id: run-tests
      run: |
        python scripts/test_runner.py \
          --code-file ${{ steps.extract-info.outputs.code_file }} \
          --language ${{ steps.extract-info.outputs.language }} \
          --sample-tests sample_tests.json \
          --generated-tests generated_tests.json
    
    - name: Update README on success
      if: steps.run-tests.outputs.result == 'PASS'
      run: |
        python scripts/update_readme.py \
          --problem-id ${{ steps.extract-info.outputs.problem_id }} \
          --author ${{ steps.extract-info.outputs.author }} \
          --submission-date $(date '+%Y-%m-%d') \
          --language ${{ steps.extract-info.outputs.language }}
    
    - name: Commit README changes
      if: steps.run-tests.outputs.result == 'PASS'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add README.md
        if ! git diff --cached --quiet; then
          git commit -m "ğŸ“Š Update progress: Problem ${{ steps.extract-info.outputs.problem_id }} solved by ${{ steps.extract-info.outputs.author }}"
          git push
        fi
    
    - name: Auto-merge on success
      if: steps.run-tests.outputs.result == 'PASS'
      run: |
        gh pr merge ${{ github.event.pull_request.number }} --auto --squash --delete-branch
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Comment test results
      if: always()
      uses: actions/github-script@v6
      with:
        script: |
          const result = '${{ steps.run-tests.outputs.result }}';
          const details = '${{ steps.run-tests.outputs.details }}';
          
          let comment = '';
          if (result === 'PASS') {
            comment = `## âœ… í…ŒìŠ¤íŠ¸ í†µê³¼!
            
            ğŸ‰ ëª¨ë“  í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ë¥¼ í†µê³¼í–ˆìŠµë‹ˆë‹¤!
            - ìƒ˜í”Œ í…ŒìŠ¤íŠ¸: í†µê³¼
            - AI ìƒì„± ë°˜ë¡€ í…ŒìŠ¤íŠ¸: í†µê³¼
            - README.mdê°€ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.
            
            ìë™ìœ¼ë¡œ ë³‘í•©ë©ë‹ˆë‹¤! ğŸš€`;
          } else {
            comment = `## âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨
            
            ë‹¤ìŒ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ì—ì„œ ë¬¸ì œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤:
            
            \`\`\`
            ${details}
            \`\`\`
            
            ì½”ë“œë¥¼ ìˆ˜ì •í•œ í›„ ë‹¤ì‹œ í‘¸ì‹œí•´ì£¼ì„¸ìš”! ğŸ’ª`;
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  deadline-reminder:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Check deadlines and send reminders
      env:
        MATTERMOST_WEBHOOK_URL: ${{ secrets.MATTERMOST_WEBHOOK_URL }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        python scripts/deadline_checker.py