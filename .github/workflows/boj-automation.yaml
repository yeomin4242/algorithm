# ì›Œí¬í”Œë¡œìš° ì´ë¦„: ì•Œê³ ë¦¬ì¦˜ ìŠ¤í„°ë”” ìë™í™” (Approve ê¸°ë°˜)
name: Algorithm Study Automation (Approve Based)

on:
  schedule:
    # KST ê¸°ì¤€ ë§¤ì£¼ ì›”ìš”ì¼ 00:00 (UTC ì¼ìš”ì¼ 15:00)
    - cron: '0 15 * * 0'
  pull_request_target:
    types: [opened, synchronize, reopened]  # submitted ì œê±°
    branches: [main]
  pull_request_review:  # ë¦¬ë·° ì´ë²¤íŠ¸ ì¶”ê°€
    types: [submitted]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  actions: write

env:
  TZ: Asia/Seoul
  PYTHON_VERSION: "3.11"
  JAVA_VERSION: "11"
  REPO_OWNER: "yeomin4242"

jobs:
  # í¬í¬ PR ìë™ ìŠ¹ì¸ ë° ì‹¤í–‰
  auto-approve-fork:
    if: github.event_name == 'pull_request_target' && github.event.pull_request.head.repo.full_name != github.repository
    runs-on: ubuntu-latest
    steps:
      - name: Auto-approve fork PRs
        uses: hmarr/auto-approve-action@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          review-message: "âœ… í¬í¬ëœ ì €ì¥ì†Œì—ì„œì˜ PRì´ ìë™ìœ¼ë¡œ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ì•Œê³ ë¦¬ì¦˜ ìŠ¤í„°ë”” ìë™í™” ì‹œìŠ¤í…œì´ ì‹¤í–‰ë©ë‹ˆë‹¤."

  test-and-update:
    # ìë™ ìŠ¹ì¸ í›„, PR ìƒì„± ì‹œ, ë˜ëŠ” ë¦¬ë·° ì œì¶œ ì‹œ ì‹¤í–‰
    needs: [auto-approve-fork]
    if: always() && (needs.auto-approve-fork.result == 'success' || needs.auto-approve-fork.result == 'skipped' || github.event_name == 'pull_request_review')
    runs-on: ubuntu-latest
    steps:
      - name: Workflow Info
        run: |
          echo "ğŸ”¥ ì•Œê³ ë¦¬ì¦˜ ìŠ¤í„°ë”” ìë™í™” ì›Œí¬í”Œë¡œìš° ì‹œì‘"
          echo "â° ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S KST')"
          echo "ğŸ”§ íŠ¸ë¦¬ê±°: ${{ github.event_name }}"
          echo "ğŸ¬ ì•¡ì…˜: ${{ github.event.action }}"
          if [ "${{ github.event_name }}" = "pull_request_target" ]; then
            echo "ğŸ” Repository: ${{ github.repository }}"
            echo "ğŸŒ¿ Head Repository: ${{ github.event.pull_request.head.repo.full_name }}"
            echo "ğŸŒ¿ Head Ref: ${{ github.event.pull_request.head.ref }}"
            echo "ğŸ‘¤ PR Author: ${{ github.event.pull_request.user.login }}"
          elif [ "${{ github.event_name }}" = "pull_request_review" ]; then
            echo "ğŸ” Repository: ${{ github.repository }}"
            echo "ğŸŒ¿ Head Repository: ${{ github.event.pull_request.head.repo.full_name }}"
            echo "ğŸŒ¿ Head Ref: ${{ github.event.pull_request.head.ref }}"
            echo "ğŸ‘¤ PR Author: ${{ github.event.pull_request.user.login }}"
            echo "ğŸ“ Review State: ${{ github.event.review.state }}"
            echo "ğŸ‘¥ Reviewer: ${{ github.event.review.user.login }}"
          fi

      # ë¸Œëœì¹˜ ì „ëµ ê²€ì¦ ë° ê¶Œí•œ í™•ì¸
      - name: Validate Branch Strategy and Permissions
        if: github.event_name == 'pull_request_target' || github.event_name == 'pull_request_review'
        id: branch-validation
        run: |
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          AUTHOR="${{ github.event.pull_request.user.login }}"
          HEAD_REPO="${{ github.event.pull_request.head.repo.full_name }}"
          BASE_REPO="${{ github.repository }}"
          REPO_OWNER="${{ env.REPO_OWNER }}"
          EVENT_NAME="${{ github.event_name }}"
          ACTION="${{ github.event.action }}"
          
          echo "ğŸ” ë¸Œëœì¹˜ ì „ëµ ê²€ì¦ ì‹œì‘"
          echo "ğŸ“‚ Head Repository: $HEAD_REPO"
          echo "ğŸ“‚ Base Repository: $BASE_REPO"
          echo "ğŸŒ¿ ë¸Œëœì¹˜: $BRANCH_NAME"
          echo "ğŸ‘¤ PR ì‘ì„±ì: $AUTHOR"
          echo "ğŸ‘‘ ì €ì¥ì†Œ ì†Œìœ ì: $REPO_OWNER"
          echo "ğŸ¬ ì´ë²¤íŠ¸: $EVENT_NAME"
          echo "ğŸ¬ ì•¡ì…˜: $ACTION"
          
          # í¬í¬ ì—¬ë¶€ í™•ì¸
          if [ "$HEAD_REPO" != "$BASE_REPO" ]; then
            echo "ğŸ”€ í¬í¬ëœ ì €ì¥ì†Œì—ì„œì˜ PRì…ë‹ˆë‹¤."
            IS_FORK="true"
          else
            echo "ğŸ“ ì›ë³¸ ì €ì¥ì†Œì—ì„œì˜ PRì…ë‹ˆë‹¤."
            IS_FORK="false"
          fi
          
          # ì €ì¥ì†Œ ì†Œìœ ìì¸ì§€ í™•ì¸
          if [ "$AUTHOR" = "$REPO_OWNER" ]; then
            echo "ğŸ‘‘ ì €ì¥ì†Œ ì†Œìœ ìì˜ PRì…ë‹ˆë‹¤."
            IS_OWNER="true"
          else
            echo "ğŸ‘¤ ì¼ë°˜ ì‚¬ìš©ìì˜ PRì…ë‹ˆë‹¤."
            IS_OWNER="false"
          fi
          
          # ìŠ¹ì¸ ì—¬ë¶€ í™•ì¸ (pull_request_review ì´ë²¤íŠ¸ì¸ ê²½ìš°)
          IS_APPROVED="false"
          if [ "$EVENT_NAME" = "pull_request_review" ] && [ "$ACTION" = "submitted" ]; then
            REVIEW_STATE="${{ github.event.review.state }}"
            echo "ğŸ“ ë¦¬ë·° ìƒíƒœ: $REVIEW_STATE"
            if [ "$REVIEW_STATE" = "approved" ]; then
              echo "âœ… PRì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!"
              IS_APPROVED="true"
            else
              echo "â„¹ï¸ PR ìŠ¹ì¸ì´ ì•„ë‹Œ ë¦¬ë·°ì…ë‹ˆë‹¤: $REVIEW_STATE"
            fi
          fi
          
          # ë¸Œëœì¹˜ ì „ëµ ê²€ì¦
          VALIDATION_RESULT="valid"
          VALIDATION_MESSAGE=""
          
          if [ "$IS_OWNER" = "true" ]; then
            # ì €ì¥ì†Œ ì†Œìœ ìëŠ” ëª¨ë“  ë¸Œëœì¹˜ íŒ¨í„´ í—ˆìš©
            echo "âœ… ì €ì¥ì†Œ ì†Œìœ ìëŠ” ëª¨ë“  ë¸Œëœì¹˜ íŒ¨í„´ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
            WEEK_NUMBER="owner"
            BRANCH_USER="$AUTHOR"
          else
            # ì¼ë°˜ ì‚¬ìš©ìëŠ” week-N-<githubID> íŒ¨í„´ ê°•ì œ
            if [[ $BRANCH_NAME =~ ^week-([0-9]+)-(.+)$ ]]; then
              WEEK_NUMBER="${BASH_REMATCH[1]}"
              BRANCH_USER="${BASH_REMATCH[2]}"
              
              echo "âœ… ì˜¬ë°”ë¥¸ ë¸Œëœì¹˜ íŒ¨í„´ì…ë‹ˆë‹¤. (week-$WEEK_NUMBER-$BRANCH_USER)"
              
              # í¬í¬ í™˜ê²½ì—ì„œëŠ” ë¸Œëœì¹˜ ì‚¬ìš©ìì™€ PR ì‘ì„±ì ì¼ì¹˜ í™•ì¸
              if [ "$IS_FORK" = "true" ]; then
                if [ "$BRANCH_USER" = "$AUTHOR" ]; then
                  echo "âœ… í¬í¬ í™˜ê²½: ë¸Œëœì¹˜ ì‚¬ìš©ìì™€ PR ì‘ì„±ìê°€ ì¼ì¹˜í•©ë‹ˆë‹¤."
                else
                  echo "âŒ í¬í¬ í™˜ê²½: ë¸Œëœì¹˜ ì‚¬ìš©ì($BRANCH_USER)ì™€ PR ì‘ì„±ì($AUTHOR)ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
                  VALIDATION_RESULT="invalid"
                  VALIDATION_MESSAGE="í¬í¬ í™˜ê²½ì—ì„œëŠ” ìì‹ ì˜ GitHub IDë¡œ ë¸Œëœì¹˜ë¥¼ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤."
                fi
              else
                echo "âœ… ì›ë³¸ ì €ì¥ì†Œ: í˜‘ì—…ìê°€ ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ë¸Œëœì¹˜ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
              fi
            else
              echo "âŒ ì¼ë°˜ ì‚¬ìš©ìëŠ” week-N-<githubID> íŒ¨í„´ì„ ë”°ë¼ì•¼ í•©ë‹ˆë‹¤."
              echo "ğŸ’¡ ì˜¬ë°”ë¥¸ ì˜ˆì‹œ: week-1-$AUTHOR, week-2-$AUTHOR"
              VALIDATION_RESULT="invalid"
              VALIDATION_MESSAGE="ë¸Œëœì¹˜ ì´ë¦„ì´ week-N-<githubID> íŒ¨í„´ì„ ë”°ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."
            fi
          fi
          
          # ê²°ê³¼ ì¶œë ¥
          echo "valid=$VALIDATION_RESULT" >> $GITHUB_OUTPUT
          echo "is_fork=$IS_FORK" >> $GITHUB_OUTPUT
          echo "is_owner=$IS_OWNER" >> $GITHUB_OUTPUT
          echo "is_approved=$IS_APPROVED" >> $GITHUB_OUTPUT
          echo "week_number=$WEEK_NUMBER" >> $GITHUB_OUTPUT
          echo "branch_user=$BRANCH_USER" >> $GITHUB_OUTPUT
          echo "validation_message=$VALIDATION_MESSAGE" >> $GITHUB_OUTPUT

      # ë¸Œëœì¹˜ ê²€ì¦ ì‹¤íŒ¨ ì‹œ PRì— ê°€ì´ë“œ ì½”ë©˜íŠ¸
      - name: Comment on Invalid Branch Strategy
        if: github.event_name == 'pull_request_target' && steps.branch-validation.outputs.valid == 'invalid'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branchName = '${{ github.event.pull_request.head.ref }}';
            const author = '${{ github.event.pull_request.user.login }}';
            const isFork = '${{ steps.branch-validation.outputs.is_fork }}' === 'true';
            const isOwner = '${{ steps.branch-validation.outputs.is_owner }}' === 'true';
            const validationMessage = '${{ steps.branch-validation.outputs.validation_message }}';
            const headRepo = '${{ github.event.pull_request.head.repo.full_name }}';
            const repoOwner = '${{ env.REPO_OWNER }}';
            
            let commentBody = `## âš ï¸ ë¸Œëœì¹˜ ì „ëµ ê²€ì¦ ì‹¤íŒ¨\n\n`;
            commentBody += `í˜„ì¬ ë¸Œëœì¹˜: \`${branchName}\`\n`;
            commentBody += `PR ì‘ì„±ì: \`${author}\`\n`;
            commentBody += `ì €ì¥ì†Œ íƒ€ì…: ${isFork ? 'ğŸ”€ í¬í¬ëœ ì €ì¥ì†Œ' : 'ğŸ“ ì›ë³¸ ì €ì¥ì†Œ'}\n`;
            commentBody += `ê¶Œí•œ: ${isOwner ? 'ğŸ‘‘ ì €ì¥ì†Œ ì†Œìœ ì' : 'ğŸ‘¤ ì¼ë°˜ ì‚¬ìš©ì'}\n\n`;
            
            commentBody += `âŒ **ë¬¸ì œ**: ${validationMessage}\n\n`;
            
            if (!isOwner) {
              commentBody += `### ğŸ“ ì¼ë°˜ ì‚¬ìš©ì ë¸Œëœì¹˜ ê·œì¹™\n`;
              commentBody += `- **íŒ¨í„´**: \`week-N-<githubID>\`\n`;
              commentBody += `- **ì˜ˆì‹œ**: \`week-1-${author}\`, \`week-2-${author}\`\n\n`;
              
              if (isFork) {
                commentBody += `### ğŸ”§ í¬í¬ í™˜ê²½ì—ì„œì˜ í•´ê²° ë°©ë²•\n`;
                commentBody += `í¬í¬ëœ ì €ì¥ì†Œ(\`${headRepo}\`)ì—ì„œ ë‹¤ìŒ ëª…ë ¹ì„ ì‹¤í–‰í•˜ì„¸ìš”:\n\n`;
                commentBody += `\`\`\`bash\n`;
                commentBody += `# ì˜¬ë°”ë¥¸ ë¸Œëœì¹˜ ì´ë¦„ìœ¼ë¡œ ë³€ê²½\n`;
                commentBody += `git branch -m ${branchName} week-1-${author}\n\n`;
                commentBody += `# ìƒˆ ë¸Œëœì¹˜ ì´ë¦„ìœ¼ë¡œ í‘¸ì‹œ\n`;
                commentBody += `git push origin week-1-${author}\n\n`;
                commentBody += `# ê¸°ì¡´ ë¸Œëœì¹˜ ì‚­ì œ\n`;
                commentBody += `git push origin --delete ${branchName}\n`;
                commentBody += `\`\`\`\n\n`;
                commentBody += `ê·¸ í›„ ìƒˆë¡œìš´ PRì„ ìƒì„±í•´ì£¼ì„¸ìš”.`;
              }
            }

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

      # ì•ˆì „í•œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Code (Safe for Forks)
        if: (github.event_name == 'pull_request_target' || github.event_name == 'pull_request_review') && steps.branch-validation.outputs.valid == 'valid'
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ (github.event_name == 'pull_request_target' || github.event_name == 'pull_request_review') && github.event.pull_request.base.ref || github.ref }}
          fetch-depth: 0
          persist-credentials: true  # ì¶”ê°€: ìê²© ì¦ëª… ìœ ì§€

      # PR ë³€ê²½ì‚¬í•­ ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜¤ê¸°
      - name: Fetch PR Changes (For Fork Safety)
        if: (github.event_name == 'pull_request_target' || github.event_name == 'pull_request_review') && steps.branch-validation.outputs.valid == 'valid'
        run: |
          echo "ğŸ”„ PR ë³€ê²½ì‚¬í•­ì„ ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜µë‹ˆë‹¤..."
          git remote add pr-head ${{ github.event.pull_request.head.repo.clone_url }}
          git fetch pr-head ${{ github.event.pull_request.head.ref }}:pr-branch
          git checkout pr-branch
          echo "âœ… PR ë¸Œëœì¹˜ë¡œ ì²´í¬ì•„ì›ƒ ì™„ë£Œ"

      - name: Setup Python and Java
        if: (github.event_name == 'pull_request_target' || github.event_name == 'pull_request_review') && steps.branch-validation.outputs.valid == 'valid'
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Setup Java
        if: github.event_name != 'pull_request_target' || steps.branch-validation.outputs.valid == 'valid'
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: "temurin"

      - name: Install Python dependencies
        if: (github.event_name == 'pull_request_target' || github.event_name == 'pull_request_review') && steps.branch-validation.outputs.valid == 'valid'
        run: |
          python -m pip install --upgrade pip
          pip install google-genai pytz requests beautifulsoup4

      # =================================================================
      #  PR í…ŒìŠ¤íŠ¸ ë¡œì§ (PR ìƒì„± ì‹œì—ë§Œ ì‹¤í–‰)
      # =================================================================
      - name: Run PR Logic - Extract & Test
        if: github.event_name == 'pull_request_target' && steps.branch-validation.outputs.valid == 'valid'
        id: pr-test
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          WEEK_NUMBER: ${{ steps.branch-validation.outputs.week_number }}
          BRANCH_USER: ${{ steps.branch-validation.outputs.branch_user }}
          IS_OWNER: ${{ steps.branch-validation.outputs.is_owner }}
        run: |
          if [ "$IS_OWNER" = "true" ]; then
            echo "ğŸ‘‘ ì €ì¥ì†Œ ì†Œìœ ìì˜ ì†”ë£¨ì…˜ì„ ë¶„ì„í•©ë‹ˆë‹¤."
          else
            echo "ğŸ“… ì£¼ì°¨ $WEEK_NUMBERì˜ $BRANCH_USERë‹˜ì˜ ì†”ë£¨ì…˜ì„ ë¶„ì„í•©ë‹ˆë‹¤."
          fi
          
          python scripts/extract_pr_info.py
          if [ -f "problems_info.json" ]; then
            python scripts/multi_test_runner.py
          else
            echo "í…ŒìŠ¤íŠ¸í•  ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤."
          fi
        continue-on-error: true

      - name: Run PR Logic - Analyze Results
        if: github.event_name == 'pull_request_target' && steps.branch-validation.outputs.valid == 'valid' && steps.pr-test.outcome != 'skipped'
        id: analyze-results
        run: python scripts/analyze_test_results.py

      - name: Run PR Logic - Post Test Results Comment
        if: github.event_name == 'pull_request_target' && steps.branch-validation.outputs.valid == 'valid' && steps.analyze-results.outcome == 'success'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const weekNumber = '${{ steps.branch-validation.outputs.week_number }}';
            const branchUser = '${{ steps.branch-validation.outputs.branch_user }}';
            const isOwner = '${{ steps.branch-validation.outputs.is_owner }}' === 'true';
            const isFork = '${{ steps.branch-validation.outputs.is_fork }}' === 'true';
            
            // íŒŒì¼ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
            if (!fs.existsSync('test_results_summary.json')) {
              console.log('test_results_summary.json íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
              return;
            }
            
            const results = JSON.parse(fs.readFileSync('test_results_summary.json', 'utf8'));
            const { overall_success, passed_problems, partial_passed_problems, failed_problems, total_problems } = results;
            
            let commentBody = `## ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½\n\n`;
            
            if (isOwner) {
              commentBody += `### ğŸ‘‘ ì €ì¥ì†Œ ì†Œìœ ì ì œì¶œ\n`;
            } else {
              commentBody += `### Week ${weekNumber} - ${branchUser}ë‹˜ì˜ ì œì¶œ\n`;
            }
            
            commentBody += `| ì „ì²´ | âœ… ì„±ê³µ | âš ï¸ ë¶€ë¶„ ì„±ê³µ | âŒ ì‹¤íŒ¨ |\n`;
            commentBody += `|:---:|:---:|:---:|:---:|\n`;
            commentBody += `| ${total_problems}ê°œ | ${passed_problems}ê°œ | ${partial_passed_problems}ê°œ | ${failed_problems}ê°œ |\n\n`;
            
            commentBody += `### ğŸ“‹ ì œì¶œ ì •ë³´\n`;
            commentBody += `- **ì œì¶œì**: ${branchUser} ${isOwner ? '(ì €ì¥ì†Œ ì†Œìœ ì)' : ''}\n`;
            if (!isOwner) {
              commentBody += `- **ì£¼ì°¨**: Week ${weekNumber}\n`;
            }
            commentBody += `- **ë¸Œëœì¹˜**: \`${{ github.event.pull_request.head.ref }}\`\n`;
            commentBody += `- **ì €ì¥ì†Œ**: ${isFork ? 'ğŸ”€ í¬í¬ëœ ì €ì¥ì†Œ' : 'ğŸ“ ì›ë³¸ ì €ì¥ì†Œ'}\n\n`;
            
            commentBody += `### ğŸ¯ ë‹¤ìŒ ë‹¨ê³„\n`;
            commentBody += `âœ… **ì´ PRì„ approveí•˜ë©´ READMEê°€ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤!**\n\n`;
            
            commentBody += `---\nğŸ‰ **í…ŒìŠ¤íŠ¸ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!** PRì„ ìŠ¹ì¸í•˜ë©´ ì œì¶œ í˜„í™©ì´ READMEì— ë°˜ì˜ë©ë‹ˆë‹¤.`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

      # =================================================================
      #  README ì—…ë°ì´íŠ¸ ë¡œì§ (Approve ì‹œì—ë§Œ ì‹¤í–‰)
      # =================================================================
      - name: Update README on Approve
        if: github.event_name == 'pull_request_review' && steps.branch-validation.outputs.is_approved == 'true' && steps.branch-validation.outputs.valid == 'valid'
        env:
          WEEK_NUMBER: ${{ steps.branch-validation.outputs.week_number }}
          BRANCH_USER: ${{ steps.branch-validation.outputs.branch_user }}
          IS_OWNER: ${{ steps.branch-validation.outputs.is_owner }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          if [ "$IS_OWNER" = "true" ]; then
            echo "ğŸ‘‘ ì €ì¥ì†Œ ì†Œìœ ìì˜ PRì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. READMEë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤."
          else
            echo "âœ… Week $WEEK_NUMBER - $BRANCH_USERë‹˜ì˜ PRì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. READMEë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤."
          fi
          
          # í˜„ì¬ ìƒíƒœ í™•ì¸
          echo "ğŸ” í˜„ì¬ ë¸Œëœì¹˜: $(git branch --show-current)"
          echo "ğŸ” í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
          echo "ğŸ” README.md ì¡´ì¬ ì—¬ë¶€: $(ls -la README.md 2>/dev/null || echo 'README.md ì—†ìŒ')"
          
          # PRì˜ ë³€ê²½ëœ íŒŒì¼ë“¤ì„ ë¶„ì„
          echo "ğŸ” PRì˜ ë³€ê²½ì‚¬í•­ì„ ë¶„ì„í•©ë‹ˆë‹¤..."
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/vnd.github.v3+json" \
               "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/files" \
               > pr_files.json
          
          echo "ğŸ“Š PR íŒŒì¼ ì •ë³´:"
          cat pr_files.json | head -20
          
          # ë¨¸ì§€ëœ PR ë¶„ì„ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          if [ -f "scripts/analyze_merged_pr.py" ]; then
            echo "ğŸ“Š PR íŒŒì¼ ë¶„ì„ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤."
            python scripts/analyze_merged_pr.py
            
            if [ -f "problems_info.json" ]; then
              echo "âœ… problems_info.json ìƒì„±ë¨:"
              cat problems_info.json
            else
              echo "âŒ problems_info.json ìƒì„± ì‹¤íŒ¨"
            fi
          else
            echo "âš ï¸ analyze_merged_pr.py ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤."
            # ìˆ˜ë™ìœ¼ë¡œ ê¸°ë³¸ ì •ë³´ ìƒì„±
            echo '{"problems": [{"problem_number": "test", "file_path": "test"}], "total_count": 1, "analysis_source": "manual"}' > problems_info.json
            echo "ğŸ“ í…ŒìŠ¤íŠ¸ìš© problems_info.json ìƒì„±"
          fi
          
          # README ì—…ë°ì´íŠ¸ ìˆ˜í–‰
          if [ -f "problems_info.json" ] && [ -f "scripts/update_readme_batch.py" ]; then
            echo "ğŸ“ README ì—…ë°ì´íŠ¸ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤."
            echo "ğŸ“‹ ì—…ë°ì´íŠ¸ ì „ README.md ë‚´ìš© (ì²˜ìŒ 10ì¤„):"
            head -10 README.md 2>/dev/null || echo "README.md ì½ê¸° ì‹¤íŒ¨"
            
            python scripts/update_readme_batch.py || {
              echo "âŒ ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ ì‹¤íŒ¨, ì•ˆì „í•œ ì—…ë°ì´íŠ¸ ìˆ˜í–‰"
              cat > safe_update.py << 'SAFE_SCRIPT'
              import os
              from datetime import datetime

              week_number = os.environ.get('WEEK_NUMBER', 'unknown')
              branch_user = os.environ.get('BRANCH_USER', 'unknown')
              pr_number = os.environ.get('PR_NUMBER', 'unknown')
              is_owner = os.environ.get('IS_OWNER', 'false')

              try:
                  if os.path.exists('README.md'):
                      with open('README.md', 'r', encoding='utf-8') as f:
                          content = f.read()
                  else:
                      content = "# ì•Œê³ ë¦¬ì¦˜ ìŠ¤í„°ë””\n\n"
                  
                  current_time = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                  
                  if is_owner.lower() == 'true':
                      update_info = f"\n## ğŸ“‹ ìµœê·¼ ì—…ë°ì´íŠ¸\n- **{current_time}**: ì €ì¥ì†Œ ì†Œìœ ì PR #{pr_number} ìŠ¹ì¸ë¨\n"
                  else:
                      update_info = f"\n## ğŸ“‹ Week {week_number} - {branch_user}\n- **PR #{pr_number}** ìŠ¹ì¸ë¨ ({current_time})\n- âœ… ì œì¶œ ì™„ë£Œ\n"
                  
                  content += update_info
                  
                  with open('README.md', 'w', encoding='utf-8') as f:
                      f.write(content)
                  
                  print("âœ… ì•ˆì „í•œ README ì—…ë°ì´íŠ¸ ì™„ë£Œ!")
              except Exception as e:
                  print(f"âŒ ì•ˆì „í•œ ì—…ë°ì´íŠ¸ë„ ì‹¤íŒ¨: {e}")
              SAFE_SCRIPT
              python safe_update.py
            }
            
            echo "ğŸ“‹ ì—…ë°ì´íŠ¸ í›„ README.md ë‚´ìš© (ë§ˆì§€ë§‰ 10ì¤„):"
            tail -10 README.md 2>/dev/null || echo "README.md ì½ê¸° ì‹¤íŒ¨"
          else
            echo "âš ï¸ í•„ìš”í•œ íŒŒì¼ì´ ì—†ì–´ ì§ì ‘ README ì—…ë°ì´íŠ¸ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤."
            cat >> README.md << DIRECT_UPDATE

            ## ğŸ“‹ Week $WEEK_NUMBER - $BRANCH_USER (Direct Update)
            - **PR #$PR_NUMBER** ìŠ¹ì¸ë¨ ($(date))
            - âœ… ì œì¶œ ì™„ë£Œ

            DIRECT_UPDATE
                        echo "âœ… ì§ì ‘ README ì—…ë°ì´íŠ¸ ì™„ë£Œ"
                      fi

      - name: Commit README Changes on Approve
        if: github.event_name == 'pull_request_review' && steps.branch-validation.outputs.is_approved == 'true' && steps.branch-validation.outputs.valid == 'valid'
        env:
          WEEK_NUMBER: ${{ steps.branch-validation.outputs.week_number }}
          BRANCH_USER: ${{ steps.branch-validation.outputs.branch_user }}
          IS_OWNER: ${{ steps.branch-validation.outputs.is_owner }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "ğŸ”§ Git ìƒíƒœ ë° README ì»¤ë°‹ ì‹œì‘"
          
          # í˜„ì¬ ìƒíƒœ í™•ì¸
          echo "ğŸ” í˜„ì¬ ë¸Œëœì¹˜: $(git branch --show-current)"
          echo "ğŸ” Git ìƒíƒœ í™•ì¸:"
          git status
          echo "ğŸ” ë³€ê²½ëœ íŒŒì¼ í™•ì¸:"
          git diff --name-only
          
          # main ë¸Œëœì¹˜ë¡œ ê°•ì œ ì²´í¬ì•„ì›ƒ ë° ìµœì‹ í™”
          echo "ğŸ“¦ main ë¸Œëœì¹˜ë¡œ ì²´í¬ì•„ì›ƒí•˜ê³  ìµœì‹ í™”í•©ë‹ˆë‹¤..."
          git fetch origin main
          git checkout main
          git reset --hard origin/main
          git pull origin main
          
          echo "âœ… main ë¸Œëœì¹˜ ì²´í¬ì•„ì›ƒ ì™„ë£Œ: $(git branch --show-current)"
          
          # ë™ì¼í•œ ë¶„ì„ì„ main ë¸Œëœì¹˜ì—ì„œ ìˆ˜í–‰
          if [ -f "pr_files.json" ] && [ -f "scripts/analyze_merged_pr.py" ]; then
            echo "ğŸ“Š main ë¸Œëœì¹˜ì—ì„œ PR ë¶„ì„ ì¬ìˆ˜í–‰"
            python scripts/analyze_merged_pr.py
          fi
          
          # README ì—…ë°ì´íŠ¸ë¥¼ main ë¸Œëœì¹˜ì—ì„œ ìˆ˜í–‰
          if [ -f "problems_info.json" ] && [ -f "scripts/update_readme_batch.py" ]; then
            echo "ğŸ“ main ë¸Œëœì¹˜ì—ì„œ README ì—…ë°ì´íŠ¸ ìˆ˜í–‰"
            python scripts/update_readme_batch.py || {
              echo "âŒ ìŠ¤í¬ë¦½íŠ¸ ì‹¤íŒ¨, ì•ˆì „í•œ ìˆ˜ë™ ì—…ë°ì´íŠ¸ ìˆ˜í–‰"
              cat >> README.md << SAFE_UPDATE

          ## ğŸ“‹ Week $WEEK_NUMBER - $BRANCH_USER (Safe Update)
          - **PR #$PR_NUMBER** ìŠ¹ì¸ë¨ ($(date '+%Y-%m-%d %H:%M:%S'))
          - âœ… ì œì¶œ ì™„ë£Œ (ìŠ¤í¬ë¦½íŠ¸ ì‹¤íŒ¨ë¡œ ìˆ˜ë™ ì—…ë°ì´íŠ¸)

          SAFE_UPDATE
                      }
                    else
                      echo "ğŸ“ íŒŒì¼ì´ ì—†ì–´ ì§ì ‘ README ì—…ë°ì´íŠ¸"
                      cat >> README.md << DIRECT_UPDATE

          ## ğŸ“‹ Week $WEEK_NUMBER - $BRANCH_USER (Direct)
          - **PR #$PR_NUMBER** ìŠ¹ì¸ë¨ ($(date '+%Y-%m-%d %H:%M:%S'))
          - âœ… ì œì¶œ ì™„ë£Œ

          DIRECT_UPDATE
                    fi
                    
                    # Git ì„¤ì • ë° ì»¤ë°‹
                    echo "ğŸ”§ Git ì‚¬ìš©ì ì„¤ì •"
                    git config --local user.email "action@github.com"
                    git config --local user.name "GitHub Action Bot"
                    
                    echo "ğŸ” ë³€ê²½ì‚¬í•­ í™•ì¸:"
                    git status
                    git diff README.md || echo "README.md diff í™•ì¸ ì‹¤íŒ¨"
                    
                    # ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ì»¤ë°‹
                    if ! git diff --quiet README.md; then
                      echo "ğŸ“ README.mdì— ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤. ì»¤ë°‹ì„ ì§„í–‰í•©ë‹ˆë‹¤."
                      
                      # ì»¤ë°‹ ë©”ì‹œì§€ êµ¬ì„±
                      if [ "$IS_OWNER" = "true" ]; then
                        COMMIT_MSG="docs: Update README.md after approving owner's PR #$PR_NUMBER"
                      else
                        COMMIT_MSG="docs: Update README.md for week-$WEEK_NUMBER by $BRANCH_USER (approved PR #$PR_NUMBER)"
                      fi
                      
                      echo "ğŸ“ ì»¤ë°‹ ë©”ì‹œì§€: $COMMIT_MSG"
                      
                      # ìŠ¤í…Œì´ì§•, ì»¤ë°‹, í‘¸ì‹œ
                      git add README.md
                      echo "âœ… README.md ìŠ¤í…Œì´ì§• ì™„ë£Œ"
                      
                      git commit -m "$COMMIT_MSG"
                      echo "âœ… ì»¤ë°‹ ì™„ë£Œ"
                      
                      echo "ğŸ“¤ main ë¸Œëœì¹˜ì— í‘¸ì‹œ ì‹œì‘..."
                      
                      # í‘¸ì‹œ ì¬ì‹œë„ ë¡œì§
                      PUSH_SUCCESS=false
                      for i in {1..3}; do
                        echo "ğŸ“¤ í‘¸ì‹œ ì‹œë„ $i/3..."
                        if git push origin main; then
                          PUSH_SUCCESS=true
                          echo "âœ… í‘¸ì‹œ ì„±ê³µ!"
                          break
                        else
                          echo "âŒ í‘¸ì‹œ ì‹¤íŒ¨, ì¬ì‹œë„ ì¤‘... ($i/3)"
                          sleep 2
                          # ìµœì‹  ìƒíƒœë¡œ ì—…ë°ì´íŠ¸ í›„ ì¬ì‹œë„
                          git fetch origin main
                          if ! git rebase origin/main; then
                            echo "âš ï¸ ë¦¬ë² ì´ìŠ¤ ì‹¤íŒ¨, ë¨¸ì§€ë¡œ ì¬ì‹œë„"
                            git rebase --abort 2>/dev/null || true
                            git merge origin/main
                          fi
                        fi
                      done
                      
                      if [ "$PUSH_SUCCESS" = "true" ]; then
                        echo "ğŸ‰ README ì—…ë°ì´íŠ¸ í‘¸ì‹œ ì™„ë£Œ!"
                        # í‘¸ì‹œ í›„ í™•ì¸
                        echo "ğŸ” í‘¸ì‹œ í›„ ì›ê²© ìƒíƒœ í™•ì¸:"
                        git log --oneline -3
                      else
                        echo "âŒ 3ë²ˆ ëª¨ë‘ í‘¸ì‹œ ì‹¤íŒ¨. ìˆ˜ë™ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."
                        exit 1
                      fi
                      
                    elif git diff --quiet; then
                      echo "â„¹ï¸ ì „ì²´ ì €ì¥ì†Œì— ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
                    else
                      echo "â„¹ï¸ README.mdì—ëŠ” ë³€ê²½ì‚¬í•­ì´ ì—†ì§€ë§Œ ë‹¤ë¥¸ íŒŒì¼ì— ë³€ê²½ì‚¬í•­ì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
                      git status
                    fi

      - name: Post Approve Success Comment
        if: github.event_name == 'pull_request_review' && steps.branch-validation.outputs.is_approved == 'true' && steps.branch-validation.outputs.valid == 'valid'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const weekNumber = '${{ steps.branch-validation.outputs.week_number }}';
            const branchUser = '${{ steps.branch-validation.outputs.branch_user }}';
            const isOwner = '${{ steps.branch-validation.outputs.is_owner }}' === 'true';
            
            let commentBody = `## ğŸ‰ README ì—…ë°ì´íŠ¸ ì™„ë£Œ!\n\n`;
            
            if (isOwner) {
              commentBody += `ğŸ‘‘ **ì €ì¥ì†Œ ì†Œìœ ìì˜ ì œì¶œì´ ìŠ¹ì¸ë˜ì–´ READMEê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.**\n\n`;
            } else {
              commentBody += `âœ… **Week ${weekNumber} - ${branchUser}ë‹˜ì˜ ì œì¶œì´ ìŠ¹ì¸ë˜ì–´ READMEê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.**\n\n`;
            }
            
            commentBody += `### ğŸ“ ë³€ê²½ì‚¬í•­\n`;
            commentBody += `- âœ… ì œì¶œ í˜„í™©ì´ READMEì— ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤\n`;
            commentBody += `- ğŸ“Š ë¬¸ì œ í•´ê²° ê¸°ë¡ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤\n\n`;
            commentBody += `ì´ì œ ì´ PRì„ ì•ˆì „í•˜ê²Œ ë¨¸ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤! ğŸš€`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

      - name: Send Mattermost DM Notification
        if: github.event_name == 'pull_request_target' && steps.branch-validation.outputs.valid == 'valid' && always() && steps.analyze-results.outcome != 'skipped'
        env:
          PERSONAL_WEBHOOK_URL: ${{ secrets[format('{0}_MATTERMOST_URL', steps.branch-validation.outputs.branch_user)] }}
          WEEK_NUMBER: ${{ steps.branch-validation.outputs.week_number }}
          BRANCH_USER: ${{ steps.branch-validation.outputs.branch_user }}
          IS_OWNER: ${{ steps.branch-validation.outputs.is_owner }}
        run: |
          if [ -n "$PERSONAL_WEBHOOK_URL" ]; then
            if [ "${{ steps.analyze-results.outputs.overall_result }}" = "PASS" ]; then
              if [ "$IS_OWNER" = "true" ]; then
                echo "âœ… ì €ì¥ì†Œ ì†Œìœ ì í…ŒìŠ¤íŠ¸ ì„±ê³µ! ì„±ê³µ ì•Œë¦¼ì„ ì „ì†¡í•©ë‹ˆë‹¤."
              else
                echo "âœ… Week $WEEK_NUMBER - $BRANCH_USERë‹˜ í…ŒìŠ¤íŠ¸ ì„±ê³µ! ì„±ê³µ ì•Œë¦¼ì„ ì „ì†¡í•©ë‹ˆë‹¤."
              fi
              python scripts/send_success_notification.py "${{ github.event.pull_request.html_url }}" "$BRANCH_USER" "$PERSONAL_WEBHOOK_URL" || echo "ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨"
            else
              if [ "$IS_OWNER" = "true" ]; then
                echo "âŒ ì €ì¥ì†Œ ì†Œìœ ì í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨! ì‹¤íŒ¨ ì•Œë¦¼ì„ ì „ì†¡í•©ë‹ˆë‹¤."
              else
                echo "âŒ Week $WEEK_NUMBER - $BRANCH_USERë‹˜ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨! ì‹¤íŒ¨ ì•Œë¦¼ì„ ì „ì†¡í•©ë‹ˆë‹¤."
              fi
              python scripts/send_failure_notification.py "${{ github.event.pull_request.html_url }}" "$BRANCH_USER" "$PERSONAL_WEBHOOK_URL" || echo "ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨"
            fi
          else
            echo "âš ï¸ $BRANCH_USERë‹˜ì˜ Mattermost ì›¹í›… URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          fi

      # =================================================================
      #  ì£¼ê°„ ì‹¤í–‰ ë¡œì§
      # =================================================================
      - name: Run Weekly Logic - Reset README for New Week
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: |
          echo "ğŸ“… ìƒˆë¡œìš´ ì£¼ì°¨ë¥¼ ìœ„í•´ READMEë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤."
          python scripts/weekly_reset.py --force

      - name: Run Weekly Logic - Commit and Push to main
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"
          if ! git diff --quiet README.md; then
            echo "README.md ë³€ê²½ì‚¬í•­ì„ main ë¸Œëœì¹˜ì— ì»¤ë°‹í•©ë‹ˆë‹¤."
            git add README.md
            git commit -m "chore: ì£¼ê°„ README ì´ˆê¸°í™”"
            git push origin main
          else
            echo "README.mdì— ë³€ê²½ì‚¬í•­ì´ ì—†ì–´ ì»¤ë°‹í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          fi