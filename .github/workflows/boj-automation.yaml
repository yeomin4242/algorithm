# ì›Œí¬í”Œë¡œìš° ì´ë¦„: ì•Œê³ ë¦¬ì¦˜ ìŠ¤í„°ë”” ìë™í™” (PR ë° ì£¼ê°„ ì—…ë°ì´íŠ¸)
name: Algorithm Study Automation (PR & Weekly)

on:
  schedule:
    # KST ê¸°ì¤€ ë§¤ì£¼ ì›”ìš”ì¼ 00:00 (UTC ì¼ìš”ì¼ 15:00)
    - cron: '0 15 * * 0'
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

env:
  TZ: Asia/Seoul
  PYTHON_VERSION: "3.11"
  JAVA_VERSION: "11"
  REPO_OWNER: "yeomin4242"  # ì €ì¥ì†Œ ì†Œìœ ì

jobs:
  test-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Workflow Info
        run: |
          echo "ğŸ”¥ ì•Œê³ ë¦¬ì¦˜ ìŠ¤í„°ë”” ìë™í™” ì›Œí¬í”Œë¡œìš° ì‹œì‘"
          echo "â° ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S KST')"
          echo "ğŸ”§ íŠ¸ë¦¬ê±°: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "ğŸ” Repository: ${{ github.repository }}"
            echo "ğŸŒ¿ Head Repository: ${{ github.event.pull_request.head.repo.full_name }}"
            echo "ğŸŒ¿ Head Ref: ${{ github.event.pull_request.head.ref }}"
            echo "ğŸ‘¤ PR Author: ${{ github.event.pull_request.user.login }}"
          fi

      # ë¸Œëœì¹˜ ì „ëµ ê²€ì¦ ë° ê¶Œí•œ í™•ì¸
      - name: Validate Branch Strategy and Permissions
        if: github.event_name == 'pull_request'
        id: branch-validation
        run: |
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          AUTHOR="${{ github.event.pull_request.user.login }}"
          HEAD_REPO="${{ github.event.pull_request.head.repo.full_name }}"
          BASE_REPO="${{ github.repository }}"
          REPO_OWNER="${{ env.REPO_OWNER }}"
          
          echo "ğŸ” ë¸Œëœì¹˜ ì „ëµ ê²€ì¦ ì‹œì‘"
          echo "ğŸ“‚ Head Repository: $HEAD_REPO"
          echo "ğŸ“‚ Base Repository: $BASE_REPO"
          echo "ğŸŒ¿ ë¸Œëœì¹˜: $BRANCH_NAME"
          echo "ğŸ‘¤ PR ì‘ì„±ì: $AUTHOR"
          echo "ğŸ‘‘ ì €ì¥ì†Œ ì†Œìœ ì: $REPO_OWNER"
          
          # í¬í¬ ì—¬ë¶€ í™•ì¸
          if [ "$HEAD_REPO" != "$BASE_REPO" ]; then
            echo "ğŸ”€ í¬í¬ëœ ì €ì¥ì†Œì—ì„œì˜ PRì…ë‹ˆë‹¤."
            IS_FORK="true"
          else
            echo "ğŸ“ ì›ë³¸ ì €ì¥ì†Œì—ì„œì˜ PRì…ë‹ˆë‹¤."
            IS_FORK="false"
          fi
          
          # ì €ì¥ì†Œ ì†Œìœ ìì¸ì§€ í™•ì¸
          if [ "$AUTHOR" = "$REPO_OWNER" ]; then
            echo "ğŸ‘‘ ì €ì¥ì†Œ ì†Œìœ ìì˜ PRì…ë‹ˆë‹¤."
            IS_OWNER="true"
          else
            echo "ğŸ‘¤ ì¼ë°˜ ì‚¬ìš©ìì˜ PRì…ë‹ˆë‹¤."
            IS_OWNER="false"
          fi
          
          # ë¸Œëœì¹˜ ì „ëµ ê²€ì¦
          VALIDATION_RESULT="valid"
          VALIDATION_MESSAGE=""
          
          if [ "$IS_OWNER" = "true" ]; then
            # ì €ì¥ì†Œ ì†Œìœ ìëŠ” ëª¨ë“  ë¸Œëœì¹˜ íŒ¨í„´ í—ˆìš©
            echo "âœ… ì €ì¥ì†Œ ì†Œìœ ìëŠ” ëª¨ë“  ë¸Œëœì¹˜ íŒ¨í„´ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
            WEEK_NUMBER="owner"
            BRANCH_USER="$AUTHOR"
          else
            # ì¼ë°˜ ì‚¬ìš©ìëŠ” week-N-<githubID> íŒ¨í„´ ê°•ì œ
            if [[ $BRANCH_NAME =~ ^week-([0-9]+)-(.+)$ ]]; then
              WEEK_NUMBER="${BASH_REMATCH[1]}"
              BRANCH_USER="${BASH_REMATCH[2]}"
              
              echo "âœ… ì˜¬ë°”ë¥¸ ë¸Œëœì¹˜ íŒ¨í„´ì…ë‹ˆë‹¤. (week-$WEEK_NUMBER-$BRANCH_USER)"
              
              # í¬í¬ í™˜ê²½ì—ì„œëŠ” ë¸Œëœì¹˜ ì‚¬ìš©ìì™€ PR ì‘ì„±ì ì¼ì¹˜ í™•ì¸
              if [ "$IS_FORK" = "true" ]; then
                if [ "$BRANCH_USER" = "$AUTHOR" ]; then
                  echo "âœ… í¬í¬ í™˜ê²½: ë¸Œëœì¹˜ ì‚¬ìš©ìì™€ PR ì‘ì„±ìê°€ ì¼ì¹˜í•©ë‹ˆë‹¤."
                else
                  echo "âŒ í¬í¬ í™˜ê²½: ë¸Œëœì¹˜ ì‚¬ìš©ì($BRANCH_USER)ì™€ PR ì‘ì„±ì($AUTHOR)ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
                  VALIDATION_RESULT="invalid"
                  VALIDATION_MESSAGE="í¬í¬ í™˜ê²½ì—ì„œëŠ” ìì‹ ì˜ GitHub IDë¡œ ë¸Œëœì¹˜ë¥¼ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤."
                fi
              else
                echo "âœ… ì›ë³¸ ì €ì¥ì†Œ: í˜‘ì—…ìê°€ ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ë¸Œëœì¹˜ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
              fi
            else
              echo "âŒ ì¼ë°˜ ì‚¬ìš©ìëŠ” week-N-<githubID> íŒ¨í„´ì„ ë”°ë¼ì•¼ í•©ë‹ˆë‹¤."
              echo "ğŸ’¡ ì˜¬ë°”ë¥¸ ì˜ˆì‹œ: week-1-$AUTHOR, week-2-$AUTHOR"
              VALIDATION_RESULT="invalid"
              VALIDATION_MESSAGE="ë¸Œëœì¹˜ ì´ë¦„ì´ week-N-<githubID> íŒ¨í„´ì„ ë”°ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."
            fi
          fi
          
          # ê²°ê³¼ ì¶œë ¥
          echo "valid=$VALIDATION_RESULT" >> $GITHUB_OUTPUT
          echo "is_fork=$IS_FORK" >> $GITHUB_OUTPUT
          echo "is_owner=$IS_OWNER" >> $GITHUB_OUTPUT
          echo "week_number=$WEEK_NUMBER" >> $GITHUB_OUTPUT
          echo "branch_user=$BRANCH_USER" >> $GITHUB_OUTPUT
          echo "validation_message=$VALIDATION_MESSAGE" >> $GITHUB_OUTPUT

      # ë¸Œëœì¹˜ ê²€ì¦ ì‹¤íŒ¨ ì‹œ PRì— ê°€ì´ë“œ ì½”ë©˜íŠ¸
      - name: Comment on Invalid Branch Strategy
        if: github.event_name == 'pull_request' && steps.branch-validation.outputs.valid == 'invalid'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branchName = '${{ github.event.pull_request.head.ref }}';
            const author = '${{ github.event.pull_request.user.login }}';
            const isFork = '${{ steps.branch-validation.outputs.is_fork }}' === 'true';
            const isOwner = '${{ steps.branch-validation.outputs.is_owner }}' === 'true';
            const validationMessage = '${{ steps.branch-validation.outputs.validation_message }}';
            const headRepo = '${{ github.event.pull_request.head.repo.full_name }}';
            const repoOwner = '${{ env.REPO_OWNER }}';
            
            let commentBody = `## âš ï¸ ë¸Œëœì¹˜ ì „ëµ ê²€ì¦ ì‹¤íŒ¨\n\n`;
            commentBody += `í˜„ì¬ ë¸Œëœì¹˜: \`${branchName}\`\n`;
            commentBody += `PR ì‘ì„±ì: \`${author}\`\n`;
            commentBody += `ì €ì¥ì†Œ íƒ€ì…: ${isFork ? 'ğŸ”€ í¬í¬ëœ ì €ì¥ì†Œ' : 'ğŸ“ ì›ë³¸ ì €ì¥ì†Œ'}\n`;
            commentBody += `ê¶Œí•œ: ${isOwner ? 'ğŸ‘‘ ì €ì¥ì†Œ ì†Œìœ ì' : 'ğŸ‘¤ ì¼ë°˜ ì‚¬ìš©ì'}\n\n`;
            
            commentBody += `âŒ **ë¬¸ì œ**: ${validationMessage}\n\n`;
            
            if (!isOwner) {
              commentBody += `### ğŸ“ ì¼ë°˜ ì‚¬ìš©ì ë¸Œëœì¹˜ ê·œì¹™\n`;
              commentBody += `- **íŒ¨í„´**: \`week-N-<githubID>\`\n`;
              commentBody += `- **ì˜ˆì‹œ**: \`week-1-${author}\`, \`week-2-${author}\`\n\n`;
              
              if (isFork) {
                commentBody += `### ğŸ”§ í¬í¬ í™˜ê²½ì—ì„œì˜ í•´ê²° ë°©ë²•\n`;
                commentBody += `í¬í¬ëœ ì €ì¥ì†Œ(\`${headRepo}\`)ì—ì„œ ë‹¤ìŒ ëª…ë ¹ì„ ì‹¤í–‰í•˜ì„¸ìš”:\n\n`;
                commentBody += `\`\`\`bash\n`;
                commentBody += `# ì˜¬ë°”ë¥¸ ë¸Œëœì¹˜ ì´ë¦„ìœ¼ë¡œ ë³€ê²½\n`;
                commentBody += `git branch -m ${branchName} week-1-${author}\n\n`;
                commentBody += `# ìƒˆ ë¸Œëœì¹˜ ì´ë¦„ìœ¼ë¡œ í‘¸ì‹œ\n`;
                commentBody += `git push origin week-1-${author}\n\n`;
                commentBody += `# ê¸°ì¡´ ë¸Œëœì¹˜ ì‚­ì œ\n`;
                commentBody += `git push origin --delete ${branchName}\n`;
                commentBody += `\`\`\`\n\n`;
                commentBody += `ê·¸ í›„ ìƒˆë¡œìš´ PRì„ ìƒì„±í•´ì£¼ì„¸ìš”.`;
              } else {
                commentBody += `### ğŸ”§ ì›ë³¸ ì €ì¥ì†Œì—ì„œì˜ í•´ê²° ë°©ë²•\n`;
                commentBody += `\`\`\`bash\n`;
                commentBody += `git branch -m ${branchName} week-1-${author}\n`;
                commentBody += `git push origin week-1-${author}\n`;
                commentBody += `git push origin --delete ${branchName}\n`;
                commentBody += `\`\`\``;
              }
              
              commentBody += `\n\n### ğŸ’¡ ì°¸ê³ ì‚¬í•­\n`;
              commentBody += `- ì €ì¥ì†Œ ì†Œìœ ì(\`${repoOwner}\`)ëŠ” ëª¨ë“  ë¸Œëœì¹˜ íŒ¨í„´ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n`;
              commentBody += `- ì¼ë°˜ ì‚¬ìš©ìëŠ” ë³´ì•ˆê³¼ ê¶Œí•œ ê´€ë¦¬ë¥¼ ìœ„í•´ ì •í•´ì§„ íŒ¨í„´ì„ ë”°ë¼ì•¼ í•©ë‹ˆë‹¤.`;
            }

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

      # ìœ íš¨í•œ ë¸Œëœì¹˜ì—ì„œë§Œ ì²´í¬ì•„ì›ƒ ì§„í–‰
      - name: Checkout Code
        if: github.event_name != 'pull_request' || steps.branch-validation.outputs.valid == 'valid'
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.event.pull_request.head.repo.full_name || github.repository }}
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          fetch-depth: 0

      - name: Setup Python and Java
        if: github.event_name != 'pull_request' || steps.branch-validation.outputs.valid == 'valid'
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Setup Java
        if: github.event_name != 'pull_request' || steps.branch-validation.outputs.valid == 'valid'
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: "temurin"

      - name: Install Python dependencies
        if: github.event_name != 'pull_request' || steps.branch-validation.outputs.valid == 'valid'
        run: |
          python -m pip install --upgrade pip
          pip install google-genai pytz requests beautifulsoup4

      # =================================================================
      #  PR ì‹¤í–‰ ë¡œì§ (ìœ íš¨í•œ ë¸Œëœì¹˜ì—ì„œë§Œ ì‹¤í–‰)
      # =================================================================
      - name: Run PR Logic - Extract & Test
        if: github.event_name == 'pull_request' && steps.branch-validation.outputs.valid == 'valid'
        id: pr-test
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          WEEK_NUMBER: ${{ steps.branch-validation.outputs.week_number }}
          BRANCH_USER: ${{ steps.branch-validation.outputs.branch_user }}
          IS_OWNER: ${{ steps.branch-validation.outputs.is_owner }}
        run: |
          if [ "$IS_OWNER" = "true" ]; then
            echo "ğŸ‘‘ ì €ì¥ì†Œ ì†Œìœ ìì˜ ì†”ë£¨ì…˜ì„ ë¶„ì„í•©ë‹ˆë‹¤."
          else
            echo "ğŸ“… ì£¼ì°¨ $WEEK_NUMBERì˜ $BRANCH_USERë‹˜ì˜ ì†”ë£¨ì…˜ì„ ë¶„ì„í•©ë‹ˆë‹¤."
          fi
          
          python scripts/extract_pr_info.py
          if [ -f "problems_info.json" ]; then
            python scripts/multi_test_runner.py
          else
            echo "í…ŒìŠ¤íŠ¸í•  ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤."
          fi
        continue-on-error: true

      - name: Run PR Logic - Analyze Results
        if: github.event_name == 'pull_request' && steps.branch-validation.outputs.valid == 'valid' && steps.pr-test.outcome != 'skipped'
        id: analyze-results
        run: python scripts/analyze_test_results.py

      - name: Run PR Logic - Update README and Commit
        if: github.event_name == 'pull_request' && steps.branch-validation.outputs.valid == 'valid' && steps.pr-test.outcome != 'skipped'
        env:
          WEEK_NUMBER: ${{ steps.branch-validation.outputs.week_number }}
          BRANCH_USER: ${{ steps.branch-validation.outputs.branch_user }}
          IS_FORK: ${{ steps.branch-validation.outputs.is_fork }}
          IS_OWNER: ${{ steps.branch-validation.outputs.is_owner }}
        run: |
          if [ "$IS_OWNER" = "true" ]; then
            echo "ğŸ“ ì €ì¥ì†Œ ì†Œìœ ìì˜ ì œì¶œì— ëŒ€í•´ README ì—…ë°ì´íŠ¸ë¥¼ ì‹œë„í•©ë‹ˆë‹¤."
          else
            echo "ğŸ“ $WEEK_NUMBERì£¼ì°¨ $BRANCH_USERë‹˜ì˜ ì œì¶œì— ëŒ€í•´ README ì—…ë°ì´íŠ¸ë¥¼ ì‹œë„í•©ë‹ˆë‹¤."
          fi
          
          python scripts/update_readme_batch.py

          if ! git diff --quiet README.md; then
            echo "README.md ë³€ê²½ì‚¬í•­ì„ ì»¤ë°‹í•©ë‹ˆë‹¤."
            
            # Git ì„¤ì •
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action Bot"
            
            # ì»¤ë°‹ ë©”ì‹œì§€ êµ¬ì„±
            if [ "$IS_OWNER" = "true" ]; then
              COMMIT_MSG="Docs: Update README.md by owner (PR #${{ github.event.pull_request.number }})"
            else
              COMMIT_MSG="Docs: Update README.md for week-$WEEK_NUMBER by $BRANCH_USER (PR #${{ github.event.pull_request.number }})"
            fi
            
            git add README.md
            git commit -m "$COMMIT_MSG"
            
            # í¬í¬ í™˜ê²½ ì²˜ë¦¬
            if [ "$IS_FORK" = "true" ]; then
              echo "ğŸ”€ í¬í¬ëœ ì €ì¥ì†Œ í™˜ê²½ì…ë‹ˆë‹¤."
              echo "âš ï¸ í¬í¬ í™˜ê²½ì—ì„œëŠ” README ì—…ë°ì´íŠ¸ë¥¼ PR ë¨¸ì§€ í›„ì— ì²˜ë¦¬í•©ë‹ˆë‹¤."
              echo "ğŸ“‹ ë³€ê²½ì‚¬í•­ì€ PR ë¨¸ì§€ ì‹œ ìë™ìœ¼ë¡œ ë°˜ì˜ë©ë‹ˆë‹¤."
              
              # ë³€ê²½ì‚¬í•­ì„ ì„ì‹œ ì €ì¥ (ë¨¸ì§€ í›„ ì²˜ë¦¬ìš©)
              git stash push -m "README update for PR #${{ github.event.pull_request.number }}"
              echo "ğŸ’¾ ë³€ê²½ì‚¬í•­ì„ stashì— ì €ì¥í–ˆìŠµë‹ˆë‹¤."
            else
              echo "ğŸ“ ì›ë³¸ ì €ì¥ì†Œ í™˜ê²½ì…ë‹ˆë‹¤."
              git push origin ${{ github.event.pull_request.head.ref }}
              echo "âœ… README ì—…ë°ì´íŠ¸ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
            fi
          else
            echo "README.mdì— ë³€ê²½ì‚¬í•­ì´ ì—†ì–´ ì»¤ë°‹í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          fi

      - name: Run PR Logic - Post Comment on PR
        if: github.event_name == 'pull_request' && steps.branch-validation.outputs.valid == 'valid' && steps.analyze-results.outcome == 'success'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const weekNumber = '${{ steps.branch-validation.outputs.week_number }}';
            const branchUser = '${{ steps.branch-validation.outputs.branch_user }}';
            const isOwner = '${{ steps.branch-validation.outputs.is_owner }}' === 'true';
            const isFork = '${{ steps.branch-validation.outputs.is_fork }}' === 'true';
            
            // íŒŒì¼ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
            if (!fs.existsSync('test_results_summary.json')) {
              console.log('test_results_summary.json íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
              return;
            }
            
            const results = JSON.parse(fs.readFileSync('test_results_summary.json', 'utf8'));
            const { overall_success, passed_problems, partial_passed_problems, failed_problems, total_problems } = results;
            
            let commentBody = `## ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½\n\n`;
            
            if (isOwner) {
              commentBody += `### ğŸ‘‘ ì €ì¥ì†Œ ì†Œìœ ì ì œì¶œ\n`;
            } else {
              commentBody += `### Week ${weekNumber} - ${branchUser}ë‹˜ì˜ ì œì¶œ\n`;
            }
            
            commentBody += `| ì „ì²´ | âœ… ì„±ê³µ | âš ï¸ ë¶€ë¶„ ì„±ê³µ | âŒ ì‹¤íŒ¨ |\n`;
            commentBody += `|:---:|:---:|:---:|:---:|\n`;
            commentBody += `| ${total_problems}ê°œ | ${passed_problems}ê°œ | ${partial_passed_problems}ê°œ | ${failed_problems}ê°œ |\n\n`;
            
            commentBody += `### ğŸ“‹ ì œì¶œ ì •ë³´\n`;
            commentBody += `- **ì œì¶œì**: ${branchUser} ${isOwner ? '(ì €ì¥ì†Œ ì†Œìœ ì)' : ''}\n`;
            if (!isOwner) {
              commentBody += `- **ì£¼ì°¨**: Week ${weekNumber}\n`;
            }
            commentBody += `- **ë¸Œëœì¹˜**: \`${{ github.event.pull_request.head.ref }}\`\n`;
            commentBody += `- **ì €ì¥ì†Œ**: ${isFork ? 'ğŸ”€ í¬í¬ëœ ì €ì¥ì†Œ' : 'ğŸ“ ì›ë³¸ ì €ì¥ì†Œ'}\n\n`;
            
            if (isFork) {
              commentBody += `### ğŸ“Œ í¬í¬ í™˜ê²½ ì•ˆë‚´\n`;
              commentBody += `- README ì—…ë°ì´íŠ¸ëŠ” PR ë¨¸ì§€ í›„ ìë™ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.\n`;
              commentBody += `- í…ŒìŠ¤íŠ¸ ê²°ê³¼ì™€ ìƒê´€ì—†ì´ ì œì¶œ í˜„í™©ì´ ë°˜ì˜ë©ë‹ˆë‹¤.\n\n`;
            }
            
            commentBody += `---\nğŸ‰ **PR ì œì¶œì´ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!** í…ŒìŠ¤íŠ¸ ê²°ê³¼ì™€ ìƒê´€ì—†ì´ ì œì¶œ í˜„í™©ì´ READMEì— ë°˜ì˜ë©ë‹ˆë‹¤.`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

      - name: Send Mattermost DM Notification
        if: github.event_name == 'pull_request' && steps.branch-validation.outputs.valid == 'valid' && always() && steps.analyze-results.outcome != 'skipped'
        env:
          PERSONAL_WEBHOOK_URL: ${{ secrets[format('{0}_MATTERMOST_URL', steps.branch-validation.outputs.branch_user)] }}
          WEEK_NUMBER: ${{ steps.branch-validation.outputs.week_number }}
          BRANCH_USER: ${{ steps.branch-validation.outputs.branch_user }}
          IS_OWNER: ${{ steps.branch-validation.outputs.is_owner }}
        run: |
          if [ -n "$PERSONAL_WEBHOOK_URL" ]; then
            if [ "${{ steps.analyze-results.outputs.overall_result }}" = "PASS" ]; then
              if [ "$IS_OWNER" = "true" ]; then
                echo "âœ… ì €ì¥ì†Œ ì†Œìœ ì í…ŒìŠ¤íŠ¸ ì„±ê³µ! ì„±ê³µ ì•Œë¦¼ì„ ì „ì†¡í•©ë‹ˆë‹¤."
              else
                echo "âœ… Week $WEEK_NUMBER - $BRANCH_USERë‹˜ í…ŒìŠ¤íŠ¸ ì„±ê³µ! ì„±ê³µ ì•Œë¦¼ì„ ì „ì†¡í•©ë‹ˆë‹¤."
              fi
              python scripts/send_success_notification.py "${{ github.event.pull_request.html_url }}" "$BRANCH_USER" "$PERSONAL_WEBHOOK_URL"
            else
              if [ "$IS_OWNER" = "true" ]; then
                echo "âŒ ì €ì¥ì†Œ ì†Œìœ ì í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨! ì‹¤íŒ¨ ì•Œë¦¼ì„ ì „ì†¡í•©ë‹ˆë‹¤."
              else
                echo "âŒ Week $WEEK_NUMBER - $BRANCH_USERë‹˜ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨! ì‹¤íŒ¨ ì•Œë¦¼ì„ ì „ì†¡í•©ë‹ˆë‹¤."
              fi
              python scripts/send_failure_notification.py "${{ github.event.pull_request.html_url }}" "$BRANCH_USER" "$PERSONAL_WEBHOOK_URL"
            fi
          else
            echo "âš ï¸ $BRANCH_USERë‹˜ì˜ Mattermost ì›¹í›… URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            echo "ğŸ’¡ ì‹œí¬ë¦¿ ì´ë¦„: ${BRANCH_USER}_MATTERMOST_URL"
          fi

      # =================================================================
      #  ì£¼ê°„ ì‹¤í–‰ ë¡œì§
      # =================================================================
      - name: Run Weekly Logic - Reset README for New Week
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: |
          echo "ğŸ“… ìƒˆë¡œìš´ ì£¼ì°¨ë¥¼ ìœ„í•´ READMEë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤."
          python scripts/weekly_reset.py --force

      - name: Run Weekly Logic - Commit and Push to main
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"
          if ! git diff --quiet README.md; then
            echo "README.md ë³€ê²½ì‚¬í•­ì„ main ë¸Œëœì¹˜ì— ì»¤ë°‹í•©ë‹ˆë‹¤."
            git add README.md
            git commit -m "chore: ì£¼ê°„ README ì´ˆê¸°í™”"
            git push origin main
          else
            echo "README.mdì— ë³€ê²½ì‚¬í•­ì´ ì—†ì–´ ì»¤ë°‹í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          fi