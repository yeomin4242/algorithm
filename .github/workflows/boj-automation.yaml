# ì›Œí¬í”Œë¡œìš° ì´ë¦„: í¬í¬ PR ìë™ ì²˜ë¦¬ (í…ŒìŠ¤íŠ¸, ì•Œë¦¼, README ì—…ë°ì´íŠ¸, ìŠ¹ì¸)
# ì„¤ëª…: ì™¸ë¶€ ê¸°ì—¬ìê°€ í¬í¬í•œ ì €ì¥ì†Œì—ì„œ ì˜¬ë°”ë¥¸ í˜•ì‹ìœ¼ë¡œ PRì„ ë³´ëƒˆì„ ë•Œ,
#       ìë™ìœ¼ë¡œ ì½”ë“œë¥¼ í…ŒìŠ¤íŠ¸í•˜ê³  ê²°ê³¼ë¥¼ ì•Œë¦° í›„, ì›ë³¸ ì €ì¥ì†Œì˜ README.mdë¥¼ ì—…ë°ì´íŠ¸í•˜ê³ ,
#       ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ë©´ í•´ë‹¹ PRì„ ìë™ìœ¼ë¡œ ìŠ¹ì¸í•©ë‹ˆë‹¤.
#       ì´ ì›Œí¬í”Œë¡œìš°ëŠ” PATë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©°, ì˜¤ì§ í¬í¬ëœ ì €ì¥ì†Œì˜ PRì—ë§Œ ë°˜ì‘í•©ë‹ˆë‹¤.

name: Fork PR Automation (Complete with Notification)

on:
  pull_request_target:
    types: [opened, synchronize, reopened]
    branches: [main]

permissions:
  contents: write
  pull-requests: write

env:
  TZ: Asia/Seoul
  PYTHON_VERSION: "3.11"
  JAVA_VERSION: "11"

jobs:
  process_fork_pr:
    # ì´ ì¡(job)ì€ í¬í¬ëœ ì €ì¥ì†Œì—ì„œ ì˜¨ PRì¼ ê²½ìš°ì—ë§Œ ì‹¤í–‰ë©ë‹ˆë‹¤.
    if: github.event.pull_request.head.repo.full_name != github.repository
    runs-on: ubuntu-latest
    steps:
      # =================================================================
      # 1. ë¸Œëœì¹˜ ì „ëµ ê²€ì¦
      # =================================================================
      - name: Validate Branch Strategy
        id: branch-validation
        run: |
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          AUTHOR="${{ github.event.pull_request.user.login }}"
          VALIDATION_RESULT="invalid"
          WEEK_NUMBER=""
          BRANCH_USER=""

          if [[ $BRANCH_NAME =~ ^week-([0-9]+)-(.+)$ ]]; then
            WEEK_NUMBER="${BASH_REMATCH[1]}"
            BRANCH_USER="${BASH_REMATCH[2]}"
            if [ "$BRANCH_USER" = "$AUTHOR" ]; then
              VALIDATION_RESULT="valid"
              echo "âœ… ìœ íš¨í•œ ë¸Œëœì¹˜ì…ë‹ˆë‹¤: ${BRANCH_NAME}"
            else
              echo "âŒ ë¸Œëœì¹˜ ì‚¬ìš©ì(${BRANCH_USER})ì™€ PR ì‘ì„±ì(${AUTHOR})ê°€ ë‹¤ë¦…ë‹ˆë‹¤."
            fi
          else
            echo "âŒ ë¸Œëœì¹˜ ì´ë¦„ì´ week-N-<githubID> íŒ¨í„´ì„ ë”°ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."
          fi
          echo "valid=$VALIDATION_RESULT" >> $GITHUB_OUTPUT
          echo "week_number=$WEEK_NUMBER" >> $GITHUB_OUTPUT
          echo "branch_user=$BRANCH_USER" >> $GITHUB_OUTPUT

      - name: Comment on Invalid Branch
        if: steps.branch-validation.outputs.valid == 'invalid'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '## âš ï¸ ë¸Œëœì¹˜ ì „ëµ ê²€ì¦ ì‹¤íŒ¨\n\në¸Œëœì¹˜ ì´ë¦„ì´ `week-N-<githubID>` íŒ¨í„´ì„ ë”°ë¥´ê³ , `<githubID>`ê°€ ë³¸ì¸ì˜ IDì™€ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.'
            });
            process.exit(1); // ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤íŒ¨ë¡œ ì¤‘ë‹¨

      # =================================================================
      # 2. PR ì½”ë“œ ì²´í¬ì•„ì›ƒ ë° í…ŒìŠ¤íŠ¸
      # =================================================================
      - name: Checkout PR Code for Testing
        if: steps.branch-validation.outputs.valid == 'valid'
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Setup Python and Java
        if: steps.branch-validation.outputs.valid == 'valid'
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Setup Java
        if: steps.branch-validation.outputs.valid == 'valid'
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: "temurin"

      - name: Install Python dependencies
        if: steps.branch-validation.outputs.valid == 'valid'
        run: |
          python -m pip install --upgrade pip
          pip install google-genai pytz requests beautifulsoup4

      - name: Run PR Logic - Extract & Test
        if: steps.branch-validation.outputs.valid == 'valid'
        id: pr-test
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          WEEK_NUMBER: ${{ steps.branch-validation.outputs.week_number }}
          BRANCH_USER: ${{ steps.branch-validation.outputs.branch_user }}
        run: |
          python scripts/extract_pr_info.py
          if [ -f "problems_info.json" ]; then
            python scripts/multi_test_runner.py
          else
            echo "í…ŒìŠ¤íŠ¸í•  ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤."
            echo '[]' > problems_info.json
          fi
        continue-on-error: true

      - name: Analyze Test Results
        if: steps.branch-validation.outputs.valid == 'valid'
        id: analyze-results
        run: python scripts/analyze_test_results.py

      - name: Post Test Results Comment
        if: steps.branch-validation.outputs.valid == 'valid'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            if (!fs.existsSync('test_results_summary.json')) {
              console.log('test_results_summary.json íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
              return;
            }
            const results = JSON.parse(fs.readFileSync('test_results_summary.json', 'utf8'));
            const { passed_problems, partial_passed_problems, failed_problems, total_problems } = results;
            const weekNumber = '${{ steps.branch-validation.outputs.week_number }}';
            const branchUser = '${{ steps.branch-validation.outputs.branch_user }}';
            
            let commentBody = `## ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½ (Week ${weekNumber} - ${branchUser})\n\n`;
            commentBody += `| ì „ì²´ | âœ… ì„±ê³µ | âš ï¸ ë¶€ë¶„ ì„±ê³µ | âŒ ì‹¤íŒ¨ |\n`;
            commentBody += `|:---:|:---:|:---:|:---:|\n`;
            commentBody += `| ${total_problems}ê°œ | ${passed_problems}ê°œ | ${partial_passed_problems}ê°œ | ${failed_problems}ê°œ |\n\n`;
            commentBody += `âœ… **ì´ PRì˜ ëª¨ë“  ìë™í™” ì‘ì—…(README ì—…ë°ì´íŠ¸, ìŠ¹ì¸)ì´ ê³§ ì™„ë£Œë©ë‹ˆë‹¤.**`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });

      # =================================================================
      # 3. Mattermost DM ì•Œë¦¼ ì „ì†¡ (ì¶”ê°€ëœ ë¶€ë¶„)
      # =================================================================
      - name: Send Mattermost DM Notification
        if: steps.branch-validation.outputs.valid == 'valid' && steps.analyze-results.outcome == 'success'
        env:
          PERSONAL_WEBHOOK_URL: ${{ secrets[format('{0}_MATTERMOST_URL', steps.branch-validation.outputs.branch_user)] }}
          WEEK_NUMBER: ${{ steps.branch-validation.outputs.week_number }}
          BRANCH_USER: ${{ steps.branch-validation.outputs.branch_user }}
          # analyze-results ìŠ¤í…ì˜ ì¶œë ¥ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
          # analyze_test_results.py ìŠ¤í¬ë¦½íŠ¸ê°€ GITHUB_OUTPUTìœ¼ë¡œ 'overall_result=PASS' ë˜ëŠ” 'overall_result=FAIL'ì„ ì¶œë ¥í•´ì•¼ í•©ë‹ˆë‹¤.
          OVERALL_RESULT: ${{ steps.analyze-results.outputs.overall_result }}
        run: |
          if [ -n "$PERSONAL_WEBHOOK_URL" ]; then
            if [ "$OVERALL_RESULT" = "PASS" ]; then
              echo "âœ… Week $WEEK_NUMBER - $BRANCH_USERë‹˜ í…ŒìŠ¤íŠ¸ ì„±ê³µ! ì„±ê³µ ì•Œë¦¼ì„ ì „ì†¡í•©ë‹ˆë‹¤."
              python scripts/send_success_notification.py "${{ github.event.pull_request.html_url }}" "$BRANCH_USER" "$PERSONAL_WEBHOOK_URL" || echo "ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨"
            else
              echo "âŒ Week $WEEK_NUMBER - $BRANCH_USERë‹˜ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨! ì‹¤íŒ¨ ì•Œë¦¼ì„ ì „ì†¡í•©ë‹ˆë‹¤."
              python scripts/send_failure_notification.py "${{ github.event.pull_request.html_url }}" "$BRANCH_USER" "$PERSONAL_WEBHOOK_URL" || echo "ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨"
            fi
          else
            echo "âš ï¸ $BRANCH_USERë‹˜ì˜ Mattermost ì›¹í›… URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          fi

      # =================================================================
      # 4. ë¶„ì„ ê²°ê³¼ë¬¼ì„ Artifactë¡œ ì„ì‹œ ì €ì¥
      # =================================================================
      - name: Upload analysis file as artifact
        if: steps.branch-validation.outputs.valid == 'valid'
        uses: actions/upload-artifact@v4
        with:
          name: problem-info-artifact
          path: problems_info.json
          retention-days: 1

      # =================================================================
      # 5. ì›ë³¸ ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ ë° README ì—…ë°ì´íŠ¸
      # =================================================================
      - name: Checkout Base Repo for README update
        if: steps.branch-validation.outputs.valid == 'valid'
        uses: actions/checkout@v4
        with:
          ref: 'main'
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download analysis file artifact
        if: steps.branch-validation.outputs.valid == 'valid'
        uses: actions/download-artifact@v4
        with:
          name: problem-info-artifact

      - name: Update README.md file
        if: steps.branch-validation.outputs.valid == 'valid'
        env:
          WEEK_NUMBER: ${{ steps.branch-validation.outputs.week_number }}
          BRANCH_USER: ${{ steps.branch-validation.outputs.branch_user }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          if [ -f "problems_info.json" ] && [ -s "problems_info.json" ] && [ "$(cat problems_info.json)" != "[]" ]; then
            echo "ğŸ“ README.md ì—…ë°ì´íŠ¸ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤."
            python scripts/update_readme_batch.py
          else
            echo "âš ï¸ README ì—…ë°ì´íŠ¸ì— í•„ìš”í•œ ì •ë³´ê°€ ì—†ì–´ ë„˜ì–´ê°‘ë‹ˆë‹¤."
          fi

      # =================================================================
      # 6. README ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
      # =================================================================
      - name: Commit and Push README.md
        if: steps.branch-validation.outputs.valid == 'valid'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: Update README for week-${{ steps.branch-validation.outputs.week_number }} by ${{ steps.branch-validation.outputs.branch_user }} (PR #${{ github.event.pull_request.number }})"
          branch: main
          commit_user_name: GitHub Action Bot
          commit_user_email: action@github.com
          file_pattern: README.md

      # =================================================================
      # 7. ëª¨ë“  ì‘ì—… ì™„ë£Œ í›„ PR ìë™ ìŠ¹ì¸
      # =================================================================
      - name: Auto-approve the PR
        if: steps.branch-validation.outputs.valid == 'valid'
        uses: hmarr/auto-approve-action@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          review-message: "âœ… ìë™í™”ëœ í…ŒìŠ¤íŠ¸ ë° README ì—…ë°ì´íŠ¸ê°€ ëª¨ë‘ ì™„ë£Œë˜ì–´ ìë™ìœ¼ë¡œ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤."
