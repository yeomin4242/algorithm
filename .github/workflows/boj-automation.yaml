# GitHub Actions ì›Œí¬í”Œë¡œìš° ì´ë¦„
name: BOJ Study Automation (Gemini API)

# ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¡°ê±´
on:
  pull_request:
    branches: [main]
  schedule:
    # ë””ë²„ê¹…ìš©: 1ë¶„ë§ˆë‹¤ ì‹¤í–‰
    - cron: "* * * * *"
    # ì‹¤ì œ ìš´ì˜ìš© (ì£¼ì„ ì²˜ë¦¬ë¨)
    # - cron: "0 0 * * 5"  # ê¸ˆìš”ì¼ ì˜¤ì „ 9ì‹œ KST
    # - cron: "0 0 * * 0"  # ì¼ìš”ì¼ ì˜¤ì „ 9ì‹œ KST
    # - cron: "0 12 * * 0" # ì¼ìš”ì¼ ì˜¤í›„ 9ì‹œ KST

# ì‹¤í–‰ë  ì‘ì—…(Job) ëª©ë¡
jobs:
  # PR ê²€ì¦ ë° ìë™ ë³‘í•© ì‘ì—…
  test-and-merge:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    # ì‘ì—…ì— í•„ìš”í•œ ê¶Œí•œ ì„¤ì •
    permissions:
      contents: write # README.md ì—…ë°ì´íŠ¸ ë° ì»¤ë°‹/í‘¸ì‹œë¥¼ ìœ„í•´ í•„ìš”
      pull-requests: write # PRì— í…ŒìŠ¤íŠ¸ ê²°ê³¼ ëŒ“ê¸€ì„ ì‘ì„±í•˜ê¸° ìœ„í•´ í•„ìš”

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      # PR ë¸Œëœì¹˜ ìì²´ë¥¼ ê°€ì ¸ì™€ 'Detached HEAD' ë¬¸ì œë¥¼ í•´ê²°í•©ë‹ˆë‹¤.
      - name: Checkout PR Branch
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.event.pull_request.head.ref }}

      # 2. Python í™˜ê²½ ì„¤ì •
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      # 3. Java í™˜ê²½ ì„¤ì •
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: "temurin"
          java-version: "11"

      # 4. Python ì˜ì¡´ì„± ì„¤ì¹˜ (Gemini API ê¸°ë°˜)
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-genai pytz beautifulsoup4 requests

      # 5. Gemini API í™˜ê²½ í…ŒìŠ¤íŠ¸ (ìµœì‹  ë²„ì „)
      - name: Test Gemini API environment
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "ğŸ¤– Gemini 2.5-flash API í™˜ê²½ í…ŒìŠ¤íŠ¸..."
          echo "Python version: $(python --version)"

          # Gemini API í‚¤ í™•ì¸
          if [ -z "$GEMINI_API_KEY" ]; then
            echo "âŒ GEMINI_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            exit 1
          else
            echo "âœ… GEMINI_API_KEY ì„¤ì • í™•ì¸ë¨"
          fi

          # ì„¤ì¹˜ëœ ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸
          echo "ğŸ“¦ ì„¤ì¹˜ëœ ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸..."
          pip list | grep -E "(google|genai)" || echo "âš ï¸ google ê´€ë ¨ íŒ¨í‚¤ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."

          # ë³„ë„ Python íŒŒì¼ ìƒì„± ë° ì‹¤í–‰
          echo "ğŸ“¦ google-genai ë¼ì´ë¸ŒëŸ¬ë¦¬ í…ŒìŠ¤íŠ¸..."
          cat > test_gemini_api.py << 'EOF'
          import os
          import sys

          print("ğŸ” Gemini 2.5-flash API ì—°ê²° í…ŒìŠ¤íŠ¸...")

          try:
              from google import genai
              from google.genai import types
              print("âœ… google-genai ë¼ì´ë¸ŒëŸ¬ë¦¬ import ì„±ê³µ")
              
              # í´ë¼ì´ì–¸íŠ¸ ì„¤ì • í…ŒìŠ¤íŠ¸
              client = genai.Client(api_key=os.environ["GEMINI_API_KEY"])
              print("âœ… Gemini 2.5-flash API í´ë¼ì´ì–¸íŠ¸ ìƒì„± ì„±ê³µ")
              
              # ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ ìš”ì²­
              print("ğŸ§ª ê°„ë‹¨í•œ API í…ŒìŠ¤íŠ¸ ìˆ˜í–‰...")
              config = types.GenerateContentConfig(
                  temperature=0.1,
                  max_output_tokens=100
              )
              
              response = client.models.generate_content(
                  model="gemini-2.5-flash",
                  contents="Hello, can you respond with just 'API_TEST_SUCCESS'?",
                  config=config
              )
              
              if hasattr(response, "text") and "API_TEST_SUCCESS" in response.text:
                  print("âœ… Gemini 2.5-flash API í…ŒìŠ¤íŠ¸ ì™„ë£Œ")
                  sys.exit(0)
              else:
                  text = response.text if hasattr(response, "text") else "No text"
                  print(f"âš ï¸ API ì‘ë‹µ í™•ì¸: {text}")
                  print("âœ… API ì—°ê²°ì€ ì„±ê³µí–ˆìœ¼ë‚˜ ì‘ë‹µ í˜•ì‹ì´ ì˜ˆìƒê³¼ ë‹¤ë¦„")
                  sys.exit(0)
                  
          except ImportError as e:
              print(f"âŒ google-genai ë¼ì´ë¸ŒëŸ¬ë¦¬ import ì‹¤íŒ¨: {e}")
              print("ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ì„¤ì¹˜í•˜ì„¸ìš”: pip install google-genai")
              sys.exit(1)
          except Exception as e:
              print(f"âŒ Gemini 2.5-flash API ì—°ê²° ì‹¤íŒ¨: {e}")
              print("API í‚¤ ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.")
              sys.exit(1)
          EOF
              
          # Python íŒŒì¼ ì‹¤í–‰
          python test_gemini_api.py

          # ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸
          echo "ğŸ“¡ ë„¤íŠ¸ì›Œí¬ ì—°ê²° í…ŒìŠ¤íŠ¸..."
          curl -I https://generativelanguage.googleapis.com/ --max-time 10 || echo "âš ï¸ Gemini API ì—”ë“œí¬ì¸íŠ¸ ì§ì ‘ ì ‘ê·¼ ì œí•œë¨"
          curl -I https://solved.ac/ --max-time 10 || echo "âš ï¸ solved.ac ì ‘ê·¼ ì œí•œë¨"

      # 6. PRì—ì„œ ë³€ê²½ëœ íŒŒì¼ë“¤ ë° ë¬¸ì œ ì •ë³´ ì¶”ì¶œ
      - name: Extract changed files and problem info
        id: extract-info
        run: |
          echo "ğŸ” PRì—ì„œ ë³€ê²½ëœ íŒŒì¼ë“¤ ë¶„ì„ ì¤‘..."
          python scripts/extract_pr_info.py
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 7. íŒŒì¼ êµ¬ì¡° ë° ìœ íš¨ì„± í™•ì¸
      - name: Check valid problems
        id: check-validity
        run: |
          HAS_VALID_PROBLEMS="${{ steps.extract-info.outputs.has_valid_problems }}"
          TOTAL_PROBLEMS="${{ steps.extract-info.outputs.total_problems_count }}"

          if [ "$HAS_VALID_PROBLEMS" = "false" ] || [ "$TOTAL_PROBLEMS" = "0" ]; then
            echo "skip_tests=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ ë¶„ì„í•  ìˆ˜ ìˆëŠ” ìœ íš¨í•œ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤."
          else
            echo "skip_tests=false" >> $GITHUB_OUTPUT
            echo "âœ… $TOTAL_PROBLEMSê°œì˜ ìœ íš¨í•œ ë¬¸ì œë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤."
          fi

      # 8. ë‹¤ì¤‘ ë¬¸ì œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      - name: Run multi-problem tests
        if: steps.check-validity.outputs.skip_tests == 'false'
        id: run-tests
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "ğŸš€ ë‹¤ì¤‘ ë¬¸ì œ í…ŒìŠ¤íŠ¸ ì‹œì‘..."
          python scripts/multi_test_runner.py
        continue-on-error: true

      # 9. í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¶„ì„
      - name: Analyze test results
        if: steps.check-validity.outputs.skip_tests == 'false'
        id: analyze-results
        run: |
          if [ -f "test_results_summary.json" ]; then
            echo "ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¶„ì„ ì¤‘..."
            
            # Pythonìœ¼ë¡œ ê²°ê³¼ ë¶„ì„
            python scripts/analyze_test_results.py
          else
            echo "âŒ í…ŒìŠ¤íŠ¸ ê²°ê³¼ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            echo "overall_result=FAIL" >> $GITHUB_OUTPUT
            echo "total_problems=0" >> $GITHUB_OUTPUT
          fi

      # 10. README.md ì—…ë°ì´íŠ¸ (ì„±ê³µí•œ ë¬¸ì œë“¤ë§Œ)
      - name: Update README for successful problems
        if: steps.analyze-results.outputs.overall_result == 'PASS'
        run: |
          if [ -f "test_results_summary.json" ]; then
            echo "ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¶„ì„ ì¤‘..."
            python scripts/update_readme_batch.py
          fi

      # 11. í…ŒìŠ¤íŠ¸ ì™„ë£Œ í™•ì¸
      - name: Verify test completion
        if: steps.check-validity.outputs.skip_tests == 'false'
        run: |
          echo "ğŸ“Š í…ŒìŠ¤íŠ¸ ì™„ë£Œ í™•ì¸..."

          if [ -f "test_results_summary.json" ]; then
            echo "âœ… í…ŒìŠ¤íŠ¸ ê²°ê³¼ íŒŒì¼ ì¡´ì¬"
            echo "ğŸ“„ ê²°ê³¼ ìš”ì•½:"
            cat test_results_summary.json | python -m json.tool | head -20
          else
            echo "âŒ í…ŒìŠ¤íŠ¸ ê²°ê³¼ íŒŒì¼ ì—†ìŒ"
          fi

      # 14. README.md ë³€ê²½ì‚¬í•­ì„ PR ë¸Œëœì¹˜ì— ì»¤ë°‹ ë° í‘¸ì‹œ
      - name: Commit and Push README changes
        if: steps.analyze-results.outputs.overall_result == 'PASS'
        run: |
          git config --local user.email "${{ github.event.pull_request.user.login }}@users.noreply.github.com"
          git config --local user.name "${{ github.event.pull_request.user.login }}"
          git add README.md
          if ! git diff --cached --quiet; then
            SUCCESS_COUNT="${{ steps.analyze-results.outputs.passed_problems }}"
            PARTIAL_COUNT="${{ steps.analyze-results.outputs.partial_passed_problems }}"
            TOTAL_COUNT="${{ steps.analyze-results.outputs.total_problems }}"
            
            git commit -m "ğŸ“Š Update progress: ${SUCCESS_COUNT}+${PARTIAL_COUNT}/${TOTAL_COUNT} problems solved by ${{ steps.extract-info.outputs.author }}"
            git push origin ${{ github.event.pull_request.head.ref }}
          else
            echo "README.mdì— ë³€ê²½ì‚¬í•­ì´ ì—†ì–´ ì»¤ë°‹í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          fi

      # 15. ìƒì„¸í•œ ì„±ê³µ ì•Œë¦¼ ì „ì†¡
      - name: Send detailed success notification
        if: steps.analyze-results.outputs.overall_result == 'PASS'
        env:
          PERSONAL_WEBHOOK_URL: ${{ secrets[format('{0}_MATTERMOST_URL', github.event.pull_request.user.login)] }}
        run: |
          echo "ğŸ“¢ ì„±ê³µ ì•Œë¦¼ ì „ì†¡ ì¤‘..."

          # í™˜ê²½ë³€ìˆ˜ í™•ì¸ (ë””ë²„ê¹…ìš©)
          echo "ì‚¬ìš©ì: ${{ github.event.pull_request.user.login }}"
          if [ -n "$PERSONAL_WEBHOOK_URL" ]; then
            echo "âœ… ê°œì¸ ì›¹í›… URL ë°œê²¬"
          else
            echo "âš ï¸ ê°œì¸ ì›¹í›… URL ì—†ìŒ, ê¸°ë³¸ ì±„ë„ ì‚¬ìš©"
          fi

          python scripts/send_success_notification.py "${{ github.event.pull_request.html_url }}" "${{ github.event.pull_request.user.login }}" "$PERSONAL_WEBHOOK_URL"

      # 16. ìƒì„¸í•œ ì‹¤íŒ¨ ì•Œë¦¼ ì „ì†¡
      - name: Send detailed failure notification
        if: steps.analyze-results.outputs.overall_result == 'FAIL'
        env:
          PERSONAL_WEBHOOK_URL: ${{ secrets[format('{0}_MATTERMOST_URL', github.event.pull_request.user.login)] }}
        run: |
          echo "ğŸ“¢ ì‹¤íŒ¨ ì•Œë¦¼ ì „ì†¡ ì¤‘..."

          # í™˜ê²½ë³€ìˆ˜ í™•ì¸ (ë””ë²„ê¹…ìš©)
          echo "ì‚¬ìš©ì: ${{ github.event.pull_request.user.login }}"
          if [ -n "$PERSONAL_WEBHOOK_URL" ]; then
            echo "âœ… ê°œì¸ ì›¹í›… URL ë°œê²¬"
          else
            echo "âš ï¸ ê°œì¸ ì›¹í›… URL ì—†ìŒ, ê¸°ë³¸ ì±„ë„ ì‚¬ìš©"
          fi

          # Pythonìœ¼ë¡œ ìƒì„¸í•œ ì‹¤íŒ¨ ì•Œë¦¼ ë©”ì‹œì§€ ìƒì„±
          python scripts/send_failure_notification.py "${{ github.event.pull_request.html_url }}" "${{ github.event.pull_request.user.login }}" "$PERSONAL_WEBHOOK_URL"

      # 17. PRì— ìƒì„¸í•œ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ëŒ“ê¸€ ì‘ì„±
      - name: Comment detailed test results
        if: always() && steps.check-validity.outputs.skip_tests == 'false'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            // í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¡œë“œ
            let results = null;
            try {
              if (fs.existsSync('test_results_summary.json')) {
                const data = fs.readFileSync('test_results_summary.json', 'utf8');
                results = JSON.parse(data);
              }
            } catch (error) {
              console.log('ê²°ê³¼ íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨:', error);
            }

            const overall_result = "${{ steps.analyze-results.outputs.overall_result }}";
            const total_problems = parseInt("${{ steps.analyze-results.outputs.total_problems }}") || 0;

            if (!results || total_problems === 0) {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## âŒ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨
                
            í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.`
              });
              return;
            }

            // ê²°ê³¼ ìš”ì•½
            const passed = results.passed_problems || 0;
            const partial = results.partial_passed_problems || 0;
            const failed = results.failed_problems || 0;
            const successRate = Math.round((passed + partial) / Math.max(total_problems, 1) * 100 * 10) / 10;

            let body = `## ğŸ“Š ë‹¤ì¤‘ ë¬¸ì œ í…ŒìŠ¤íŠ¸ ê²°ê³¼

            **ì „ì²´ ê²°ê³¼**: ${overall_result === 'PASS' ? 'âœ… ì„±ê³µ' : 'âŒ ì‹¤íŒ¨'} (ì„±ê³µë¥ : ${successRate}%)

            | êµ¬ë¶„ | ì™„ì „ ì„±ê³µ | ë¶€ë¶„ ì„±ê³µ | ì‹¤íŒ¨ | ì „ì²´ |
            |------|-----------|-----------|------|------|
            | ê°œìˆ˜ | ${passed}ê°œ | ${partial}ê°œ | ${failed}ê°œ | ${total_problems}ê°œ |

            `;

            // ê° ë¬¸ì œë³„ ìƒì„¸ ê²°ê³¼
            if (results.details && results.details.length > 0) {
              body += `### ğŸ“ ë¬¸ì œë³„ ìƒì„¸ ê²°ê³¼\n\n`;
              
              for (const detail of results.details) {
                const statusEmoji = {
                  'PASS': 'âœ…',
                  'PARTIAL_PASS': 'âš ï¸',
                  'FAIL': 'âŒ',
                  'ERROR': 'ğŸ’¥'
                }[detail.result] || 'â“';
                
                body += `#### ${statusEmoji} ë¬¸ì œ ${detail.problem_id} (${detail.author})\n`;
                body += `- **ê²°ê³¼**: ${detail.result}\n`;
                body += `- **ê²€ìƒ‰**: ${detail.search_success ? 'ì„±ê³µ' : 'ì‹¤íŒ¨'}\n`;
                
                if (detail.sample_tests && detail.sample_tests.total > 0) {
                  const st = detail.sample_tests;
                  body += `- **ìƒ˜í”Œ í…ŒìŠ¤íŠ¸**: ${st.passed}/${st.total} í†µê³¼\n`;
                }
                
                if (detail.generated_tests && detail.generated_tests.total > 0) {
                  const gt = detail.generated_tests;
                  body += `- **ìƒì„± í…ŒìŠ¤íŠ¸**: ${gt.passed}/${gt.total} í†µê³¼\n`;
                }
                
                if (detail.errors && detail.errors.length > 0) {
                  body += `- **ì˜¤ë¥˜**: ${detail.errors[0]}\n`;
                }
                
                body += `\n`;
              }
            }

            // ê²°ë¡ 
            if (overall_result === 'PASS') {
              body += `### ğŸ‰ í…ŒìŠ¤íŠ¸ í†µê³¼!
              
            í•œ ë¬¸ì œ ì´ìƒì´ ì„±ê³µí–ˆìœ¼ë¯€ë¡œ **PRì´ ìŠ¹ì¸ë©ë‹ˆë‹¤**.
            ì‹¤íŒ¨í•œ ë¬¸ì œë“¤ì€ BOJ ì‚¬ì´íŠ¸ì—ì„œ ì§ì ‘ í™•ì¸ í›„ ìˆ˜ì •í•´ì£¼ì„¸ìš”.

            ë¸Œëœì¹˜ë¥¼ ë³‘í•©í•˜ê³  ì‚­ì œí•´ì£¼ì„¸ìš”! ğŸš€`;
            } else {
              body += `### âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨
              
            ëª¨ë“  ë¬¸ì œê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì½”ë“œë¥¼ ìˆ˜ì •í•œ í›„ ë‹¤ì‹œ í‘¸ì‹œí•´ì£¼ì„¸ìš”.

            ğŸ’¡ **íŒ**: ê° ë¬¸ì œë³„ ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ í™•ì¸í•˜ì—¬ ìˆ˜ì •í•´ë³´ì„¸ìš”.`;
            }

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      # 18. í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ (ë””ë²„ê·¸ìš©)
      - name: Upload test results
        if: always() && steps.check-validity.outputs.skip_tests == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.event.pull_request.number }}
          path: |
            test_results_summary.json
            problems_info.json
            problem_*_info.json
            tests_*.json
            sample_*_tests.json
          retention-days: 7

  # ë°ë“œë¼ì¸ ì•Œë¦¼ ì‘ì—…
  deadline-reminder:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pytz
      - name: Check deadlines and send reminders
        env:
          MATTERMOST_WEBHOOK_URL: ${{ secrets.MATTERMOST_WEBHOOK_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEBUG_MODE: "true" # ë””ë²„ê¹… ëª¨ë“œ í™œì„±í™”
          # ê°œì¸ë³„ webhook URLs (ê° ì°¸ê°€ìë³„ë¡œ ì„¤ì •)
          yeomin4242_MATTERMOST_URL: ${{ secrets.yeomin4242_MATTERMOST_URL }}
        run: python scripts/deadline_checker.py
