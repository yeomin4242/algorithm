name: BOJ Study Automation

on:
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 */2 * * *'  # 2ì‹œê°„ë§ˆë‹¤ ë°ë“œë¼ì¸ ì²´í¬

jobs:
  test-and-merge:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        ref: ${{ github.event.pull_request.head.sha }}
    
    - name: Fetch PR changes
      run: |
        git fetch origin ${{ github.event.pull_request.base.ref }}
        git fetch origin ${{ github.event.pull_request.head.ref }}
        echo "=== PR ì •ë³´ ==="
        echo "Base: ${{ github.event.pull_request.base.sha }}"
        echo "Head: ${{ github.event.pull_request.head.sha }}"
        echo "=== ë³€ê²½ëœ íŒŒì¼ë“¤ ==="
        git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }}
        echo "=== í˜„ì¬ ë””ë ‰í† ë¦¬ êµ¬ì¡° ==="
        find . -name "Main.java" -type f | head -10
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '11'
    
    - name: Install dependencies
      run: |
        pip install requests beautifulsoup4 google-generativeai pytz
    
    - name: Extract problem and code info
      id: extract-info
      run: |
        # 1. PRì˜ ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        #    base ë¸Œëœì¹˜(main)ì™€ head ë¸Œëœì¹˜(PR) ì‚¬ì´ì˜ ì°¨ì´ë¥¼ ë¹„êµí•©ë‹ˆë‹¤.
        CHANGED_FILES=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...${{ github.event.pull_request.head.sha }})
        echo "Git Diff Result:"
        echo "${CHANGED_FILES}"

        # 2. 'ì´ë¦„/ë¬¸ì œë²ˆí˜¸/Main.java' íŒ¨í„´ì— ë§ëŠ” íŒŒì¼ ê²½ë¡œ ì°¾ê¸°
        #    grep -E: ì •ê·œ í‘œí˜„ì‹ìœ¼ë¡œ ê²€ìƒ‰
        #    head -n 1: ì—¬ëŸ¬ íŒŒì¼ì´ ë³€ê²½ëœ ê²½ìš° ì²« ë²ˆì§¸ íŒŒì¼ë§Œ ì„ íƒ
        FILE_PATH=$(echo "${CHANGED_FILES}" | grep -E '^[^/]+/[0-9]+/Main\.java$' | head -n 1)

        # 3. Fallback: git diffë¡œ ëª»ì°¾ìœ¼ë©´ ì „ì²´ ë””ë ‰í† ë¦¬ì—ì„œ ê²€ìƒ‰
        if [ -z "$FILE_PATH" ]; then
          echo "File not found via git diff. Fallback: Searching entire directory..."
          # find . -path '*/<ìˆ«ì>/Main.java' í˜•ì‹ì˜ íŒŒì¼ ê²€ìƒ‰
          FILE_PATH=$(find . -path '*/[0-9]*/Main.java' -not -path './.git/*' | head -n 1)
          # ê²½ë¡œ ì•ì˜ './' ì œê±°
          FILE_PATH=${FILE_PATH#./}
        fi

        # 4. ìµœì¢…ì ìœ¼ë¡œ íŒŒì¼ì„ ì°¾ì•˜ëŠ”ì§€ í™•ì¸
        if [ -z "$FILE_PATH" ]; then
          echo "::error::Could not find a valid Main.java file. Please follow the '<name>/<problem_number>/Main.java' structure."
          # ì›Œí¬í”Œë¡œìš°ì˜ í›„ì† ë‹¨ê³„(ì£¼ì„ ë‹¬ê¸°)ê°€ ì‹¤í–‰ë  ìˆ˜ ìˆë„ë¡ ë”ë¯¸ ê°’ì„ ì„¤ì •í•˜ê³  ì •ìƒ ì¢…ë£Œ
          echo "problem_id=0000" >> $GITHUB_OUTPUT
          echo "author=unknown" >> $GITHUB_OUTPUT
          echo "code_file=none" >> $GITHUB_OUTPUT
          echo "language=unknown" >> $GITHUB_OUTPUT
        else
          echo "âœ… File found: ${FILE_PATH}"
          # ì°¾ì€ íŒŒì¼ ê²½ë¡œë¥¼ í™˜ê²½ ë³€ìˆ˜ë¡œ ì„¤ì •í•˜ì—¬ Python ìŠ¤í¬ë¦½íŠ¸ì— ì „ë‹¬
          export MAIN_JAVA_FILE_PATH="${FILE_PATH}"
          python scripts/extract_pr_info.py
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Skip test if dummy values
      id: check-skip
      run: |
        if [ "${{ steps.extract-info.outputs.problem_id }}" = "0000" ] || [ "${{ steps.extract-info.outputs.author }}" = "unknown" ]; then
          echo "skip_tests=true" >> $GITHUB_OUTPUT
          echo "âš ï¸  íŒŒì¼ êµ¬ì¡° ì˜¤ë¥˜ë¡œ ì¸í•´ í…ŒìŠ¤íŠ¸ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
        else
          echo "skip_tests=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Get problem details from BOJ
      if: steps.check-skip.outputs.skip_tests == 'false'
      id: problem-details
      run: |
        python scripts/fetch_boj_problem.py \
          --problem-id ${{ steps.extract-info.outputs.problem_id }}
    
    - name: Generate test cases with Gemini
      if: steps.check-skip.outputs.skip_tests == 'false'
      id: generate-tests
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
      run: |
        python scripts/gemini_test_generator.py \
          --problem-id ${{ steps.extract-info.outputs.problem_id }} \
          --code-file ${{ steps.extract-info.outputs.code_file }} \
          --language ${{ steps.extract-info.outputs.language }} \
          --problem-info problem_info.json
    
    - name: Run all tests
      if: steps.check-skip.outputs.skip_tests == 'false'
      id: run-tests
      run: |
        python scripts/test_runner.py \
          --code-file ${{ steps.extract-info.outputs.code_file }} \
          --language ${{ steps.extract-info.outputs.language }} \
          --sample-tests sample_tests.json \
          --generated-tests generated_tests.json
    
    - name: Update README on success
      if: steps.check-skip.outputs.skip_tests == 'false' && steps.run-tests.outputs.result == 'PASS'
      run: |
        python scripts/update_readme.py \
          --problem-id ${{ steps.extract-info.outputs.problem_id }} \
          --author ${{ steps.extract-info.outputs.author }} \
          --submission-date $(date '+%Y-%m-%d') \
          --language ${{ steps.extract-info.outputs.language }}
    
    - name: Commit README changes
      if: steps.check-skip.outputs.skip_tests == 'false' && steps.run-tests.outputs.result == 'PASS'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add README.md
        if ! git diff --cached --quiet; then
          git commit -m "ğŸ“Š Update progress: Problem ${{ steps.extract-info.outputs.problem_id }} solved by ${{ steps.extract-info.outputs.author }}"
          git push
        fi
    
    - name: Auto-merge on success
      if: steps.check-skip.outputs.skip_tests == 'false' && steps.run-tests.outputs.result == 'PASS'
      run: |
        gh pr merge ${{ github.event.pull_request.number }} --auto --squash --delete-branch
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Comment test results
      if: always()
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const result = '${{ steps.run-tests.outputs.result }}';
          const details = '${{ steps.run-tests.outputs.details }}';
          const problemId = '${{ steps.extract-info.outputs.problem_id }}';
          const author = '${{ steps.extract-info.outputs.author }}';
          
          // problemIdê°€ 0000ì´ë©´ íŒŒì¼ êµ¬ì¡° ì˜¤ë¥˜
          if (problemId === '0000' || author === 'unknown') {
            const comment = `## ğŸ“ íŒŒì¼ êµ¬ì¡° ì˜¤ë¥˜
            
            ì˜¬ë°”ë¥¸ íŒŒì¼ êµ¬ì¡°ë¡œ ì œì¶œí•´ì£¼ì„¸ìš”:
            
            âœ… **ì˜¬ë°”ë¥¸ êµ¬ì¡°**:
            \`\`\`
            ë³¸ì¸ì´ë¦„/ë¬¸ì œë²ˆí˜¸/Main.java
            ì˜ˆ: alice/1654/Main.java
            \`\`\`
            
            âŒ **ì˜ëª»ëœ êµ¬ì¡°**:
            - íŒŒì¼ëª…ì´ Main.javaê°€ ì•„ë‹˜
            - ì‘ì„±ì ë””ë ‰í† ë¦¬ê°€ ì—†ìŒ  
            - ë¬¸ì œë²ˆí˜¸ ë””ë ‰í† ë¦¬ê°€ ì—†ìŒ
            
            êµ¬ì¡°ë¥¼ ìˆ˜ì •í•œ í›„ ë‹¤ì‹œ í‘¸ì‹œí•´ì£¼ì„¸ìš”! ğŸ“`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
            return;
          }
          
          let comment = '';
          if (result === 'PASS') {
            comment = `## âœ… í…ŒìŠ¤íŠ¸ í†µê³¼!
            
            ğŸ‰ **${author}ë‹˜ì˜ ë¬¸ì œ ${problemId} í•´ê²°ì„ ì¶•í•˜í•©ë‹ˆë‹¤!**
            - âœ… ìƒ˜í”Œ í…ŒìŠ¤íŠ¸: í†µê³¼
            - ğŸ¤– AI ìƒì„± ë°˜ë¡€ í…ŒìŠ¤íŠ¸: í†µê³¼
            - ğŸ“Š README.mdê°€ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.
            
            ìë™ìœ¼ë¡œ ë³‘í•©ë©ë‹ˆë‹¤! ğŸš€`;
          } else {
            comment = `## âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨
            
            **${author}ë‹˜ì˜ ë¬¸ì œ ${problemId} ì½”ë“œì—ì„œ ë¬¸ì œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤:**
            
            \`\`\`
            ${details}
            \`\`\`
            
            ì½”ë“œë¥¼ ìˆ˜ì •í•œ í›„ ë‹¤ì‹œ í‘¸ì‹œí•´ì£¼ì„¸ìš”! ğŸ’ª`;
          }
          
          try {
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          } catch (error) {
            console.log('ëŒ“ê¸€ ì‘ì„± ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤:', error.message);
            // ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨í•´ë„ ì›Œí¬í”Œë¡œìš°ëŠ” ê³„ì† ì§„í–‰
          }

  deadline-reminder:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Check deadlines and send reminders
      env:
        MATTERMOST_WEBHOOK_URL: ${{ secrets.MATTERMOST_WEBHOOK_URL }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        python scripts/deadline_checker.py