# ì›Œí¬í”Œë¡œìš° ì´ë¦„: ì•Œê³ ë¦¬ì¦˜ ìŠ¤í„°ë”” ìë™í™” (PR ë° ì£¼ê°„ ì—…ë°ì´íŠ¸)
name: Algorithm Study Automation (PR & Weekly)

on:
  schedule:
    # KST ê¸°ì¤€ ë§¤ì£¼ ì›”ìš”ì¼ 00:00 (UTC ì¼ìš”ì¼ 15:00)
    - cron: '0 15 * * 0'
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

env:
  TZ: Asia/Seoul
  PYTHON_VERSION: "3.11"
  JAVA_VERSION: "11"

jobs:
  test-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Workflow Info
        run: |
          echo "ğŸ”¥ ì•Œê³ ë¦¬ì¦˜ ìŠ¤í„°ë”” ìë™í™” ì›Œí¬í”Œë¡œìš° ì‹œì‘"
          echo "â° ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S KST')"
          echo "ğŸ”§ íŠ¸ë¦¬ê±°: ${{ github.event_name }}"

      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.event.pull_request.head.ref || 'main' }}
          fetch-depth: 0

      - name: Setup Python and Java
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: "temurin"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-genai pytz requests beautifulsoup4

      # =================================================================
      #  PR ì‹¤í–‰ ë¡œì§
      # =================================================================
      - name: Run PR Logic - Extract & Test
        if: github.event_name == 'pull_request'
        id: pr-test
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          python scripts/extract_pr_info.py
          if [ -f "problems_info.json" ]; then
            python scripts/multi_test_runner.py
          else
            echo "í…ŒìŠ¤íŠ¸í•  ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤."
          fi
        continue-on-error: true

      - name: Run PR Logic - Analyze Results
        # [ìˆ˜ì •] í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í•´ë„ ê²°ê³¼ ë¶„ì„ì„ ì‹¤í–‰í•˜ë„ë¡ ì¡°ê±´ ë³€ê²½
        if: github.event_name == 'pull_request' && steps.pr-test.outcome != 'skipped'
        id: analyze-results
        run: python scripts/analyze_test_results.py

      - name: Run PR Logic - Update README & Post Comment
        # ì´ ë‹¨ê³„ëŠ” ë¶„ì„ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆì„ ë•Œë§Œ ì‹¤í–‰ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
        if: github.event_name == 'pull_request' && steps.analyze-results.outcome == 'success'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const exec = require('@actions/exec');
            const results = JSON.parse(fs.readFileSync('test_results_summary.json', 'utf8'));
            const { overall_success, passed_problems, partial_passed_problems, failed_problems, total_problems } = results;

            if (overall_success) {
              await exec.exec('python', ['scripts/update_readme_batch.py']);
              const gitStatus = await exec.getExecOutput('git', ['status', '--porcelain']);
              if (gitStatus.stdout.includes('README.md')) {
                await exec.exec('git', ['config', 'user.name', 'GitHub Action Bot']);
                await exec.exec('git', ['config', 'user.email', 'action@github.com']);
                await exec.exec('git', ['add', 'README.md']);
                await exec.exec('git', ['commit', '-m', 'docs: PR #${{ github.event.pull_request.number }} ì œì¶œ í˜„í™© ë°˜ì˜']);
                await exec.exec('git', ['push']);
              }
            }
            
            let commentBody = `## ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½\n\n`;
            commentBody += `| ì „ì²´ | âœ… ì„±ê³µ | âš ï¸ ë¶€ë¶„ ì„±ê³µ | âŒ ì‹¤íŒ¨ |\n`;
            commentBody += `|:---:|:---:|:---:|:---:|\n`;
            commentBody += `| ${total_problems}ê°œ | ${passed_problems}ê°œ | ${partial_passed_problems}ê°œ | ${failed_problems}ê°œ |\n\n`;
            if (overall_success) {
              commentBody += `\n---\nğŸ‰ **í…ŒìŠ¤íŠ¸ í†µê³¼!** PRì„ ë³‘í•©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
            } else {
              commentBody += `\n---\nâŒ **í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨.** ì½”ë“œë¥¼ ìˆ˜ì •í•œ í›„ ë‹¤ì‹œ í‘¸ì‹œí•´ì£¼ì„¸ìš”.`;
            }
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

      - name: Send Mattermost DM Notification
        # [ìˆ˜ì •] í…ŒìŠ¤íŠ¸ ê²°ê³¼ì™€ ìƒê´€ì—†ì´ í•­ìƒ ì•Œë¦¼ì„ ë³´ë‚´ë„ë¡ ì¡°ê±´ ë³€ê²½
        if: github.event_name == 'pull_request' && always() && steps.analyze-results.outcome != 'skipped'
        env:
          # PR ì‘ì„±ìì˜ ê°œì¸ Webhook URLì„ ë™ì ìœ¼ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
          PERSONAL_WEBHOOK_URL: ${{ secrets[format('{0}_MATTERMOST_URL', github.event.pull_request.user.login)] }}
        run: |
          # í…ŒìŠ¤íŠ¸ ê²°ê³¼(ì„±ê³µ/ì‹¤íŒ¨)ì— ë”°ë¼ ë‹¤ë¥¸ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
          if [ "${{ steps.analyze-results.outputs.overall_result }}" = "PASS" ]; then
            echo "âœ… í…ŒìŠ¤íŠ¸ ì„±ê³µ! ì„±ê³µ ì•Œë¦¼ì„ ì „ì†¡í•©ë‹ˆë‹¤."
            python scripts/send_success_notification.py "${{ github.event.pull_request.html_url }}" "${{ github.event.pull_request.user.login }}" "$PERSONAL_WEBHOOK_URL"
          else
            echo "âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨! ì‹¤íŒ¨ ì•Œë¦¼ì„ ì „ì†¡í•©ë‹ˆë‹¤."
            python scripts/send_failure_notification.py "${{ github.event.pull_request.html_url }}" "${{ github.event.pull_request.user.login }}" "$PERSONAL_WEBHOOK_URL"
          fi

      # =================================================================
      #  ì£¼ê°„ ì‹¤í–‰ ë¡œì§ (ê¸°ì¡´ê³¼ ë™ì¼)
      # =================================================================
      - name: Run Weekly Logic - Reset README for New Week
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: |
          echo "ğŸ“… ìƒˆë¡œìš´ ì£¼ì°¨ë¥¼ ìœ„í•´ READMEë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤."
          python scripts/weekly_reset.py --force

      - name: Run Weekly Logic - Commit and Push to main
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"
          if ! git diff --quiet README.md; then
            echo "README.md ë³€ê²½ì‚¬í•­ì„ main ë¸Œëœì¹˜ì— ì»¤ë°‹í•©ë‹ˆë‹¤."
            git add README.md
            git commit -m "chore: ì£¼ê°„ README ì´ˆê¸°í™”"
            git push origin main
          else
            echo "README.mdì— ë³€ê²½ì‚¬í•­ì´ ì—†ì–´ ì»¤ë°‹í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          fi
