# GitHub Actions ì›Œí¬í”Œë¡œìš° ì´ë¦„
name: BOJ Study Automation

# ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¡°ê±´
on:
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 */2 * * *'

# ì‹¤í–‰ë  ì‘ì—…(Job) ëª©ë¡
jobs:
  # PR ê²€ì¦ ë° ìë™ ë³‘í•© ì‘ì—…
  test-and-merge:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    # ì‘ì—…ì— í•„ìš”í•œ ê¶Œí•œ ì„¤ì •
    permissions:
      contents: write        # README.md ì—…ë°ì´íŠ¸ ë° ì»¤ë°‹/í‘¸ì‹œë¥¼ ìœ„í•´ í•„ìš”
      pull-requests: write   # PRì— í…ŒìŠ¤íŠ¸ ê²°ê³¼ ëŒ“ê¸€ì„ ì‘ì„±í•˜ê¸° ìœ„í•´ í•„ìš”

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      # PR ë¸Œëœì¹˜ ìì²´ë¥¼ ê°€ì ¸ì™€ 'Detached HEAD' ë¬¸ì œë¥¼ í•´ê²°í•©ë‹ˆë‹¤.
      - name: Checkout PR Branch
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.event.pull_request.head.ref }}

      # 2. Python í™˜ê²½ ì„¤ì •
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      # 3. Java í™˜ê²½ ì„¤ì •
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '11'

      # 4. Python ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: pip install google-generativeai pytz selenium webdriver-manager beautifulsoup4 requests

      # 5. PRì—ì„œ ë¬¸ì œ ë° ì½”ë“œ ì •ë³´ ì¶”ì¶œ (GitHub API ì‚¬ìš©ìœ¼ë¡œ ë³€ê²½)
      - name: Extract problem and code info
        id: extract-info
        run: python scripts/extract_pr_info.py # ìŠ¤í¬ë¦½íŠ¸ ë‚´ë¶€ì—ì„œ APIë¥¼ í˜¸ì¶œí•˜ë„ë¡ ë³€ê²½
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 6. íŒŒì¼ êµ¬ì¡°ê°€ ì˜¬ë°”ë¥´ì§€ ì•Šìœ¼ë©´ í…ŒìŠ¤íŠ¸ ê±´ë„ˆë›°ê¸°
      - name: Skip test if dummy values
        id: check-skip
        run: |
          if [ "${{ steps.extract-info.outputs.problem_id }}" = "0000" ]; then
            echo "skip_tests=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ íŒŒì¼ êµ¬ì¡° ì˜¤ë¥˜ë¡œ ì¸í•´ í…ŒìŠ¤íŠ¸ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
          else
            echo "skip_tests=false" >> $GITHUB_OUTPUT
          fi

      # 7. solved.ac APIë¡œ ë¬¸ì œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      - name: Get problem details from solved.ac
        if: steps.check-skip.outputs.skip_tests == 'false'
        run: |
          python scripts/fetch_boj_problem.py \
            --problem-id ${{ steps.extract-info.outputs.problem_id }}

      # 8. Gemini APIë¡œ ë°˜ë¡€ í…ŒìŠ¤íŠ¸ì¼€ì´ìŠ¤ ìƒì„±
      - name: Generate test cases with Gemini
        if: steps.check-skip.outputs.skip_tests == 'false'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python scripts/gemini_test_generator.py \
            --problem-id ${{ steps.extract-info.outputs.problem_id }} \
            --code-file ${{ steps.extract-info.outputs.code_file }} \
            --language ${{ steps.extract-info.outputs.language }} \
            --problem-info problem_info.json

      # 9. ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      - name: Run all tests
        if: steps.check-skip.outputs.skip_tests == 'false'
        id: run-tests
        run: |
          python scripts/test_runner.py \
            --code-file ${{ steps.extract-info.outputs.code_file }} \
            --language ${{ steps.extract-info.outputs.language }} \
            --sample-tests sample_tests.json \
            --generated-tests generated_tests.json

      # 10. í…ŒìŠ¤íŠ¸ í†µê³¼ ì‹œ README.md ì—…ë°ì´íŠ¸
      - name: Update README on success
        if: steps.run-tests.outputs.result == 'PASS'
        run: |
          python scripts/update_readme.py \
            --problem-id ${{ steps.extract-info.outputs.problem_id }} \
            --author ${{ steps.extract-info.outputs.author }} \
            --submission-date $(date '+%Y-%m-%d') \
            --language ${{ steps.extract-info.outputs.language }}

      # 11. README.md ë³€ê²½ì‚¬í•­ì„ PR ë¸Œëœì¹˜ì— ì»¤ë°‹ ë° í‘¸ì‹œ
      - name: Commit and Push README changes
        if: steps.run-tests.outputs.result == 'PASS'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          if ! git diff --cached --quiet; then
            git commit -m "ğŸ“Š Update progress: Problem ${{ steps.extract-info.outputs.problem_id }} solved by ${{ steps.extract-info.outputs.author }}"
            git push origin ${{ github.event.pull_request.head.ref }}
          else
            echo "README.mdì— ë³€ê²½ì‚¬í•­ì´ ì—†ì–´ ì»¤ë°‹í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          fi

      # 12. í…ŒìŠ¤íŠ¸ í†µê³¼ ì‹œ Mattermost ì•Œë¦¼ ì „ì†¡
      - name: Send Mattermost notification on success
        if: steps.run-tests.outputs.result == 'PASS'
        run: |
          curl -X POST "${{ secrets.MATTERMOST_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "{\"payload\": {
                          \"channel\": \"algorithm-study\",
                          \"username\": \"BOJ-Bot\",
                          \"icon_emoji\": \":white_check_mark:\",
                          \"text\": \"ğŸ‰ **í…ŒìŠ¤íŠ¸ í†µê³¼!**\",
                          \"attachments\": [
                            {
                              \"color\": \"good\",
                              \"fields\": [
                                {
                                  \"title\": \"ë¬¸ì œ ë²ˆí˜¸\",
                                  \"value\": \"${{ steps.extract-info.outputs.problem_id }}\",
                                  \"short\": true
                                },
                                {
                                  \"title\": \"í•´ê²°ì\",
                                  \"value\": \"${{ steps.extract-info.outputs.author }}\",
                                  \"short\": true
                                },
                                {
                                  \"title\": \"ì–¸ì–´\",
                                  \"value\": \"${{ steps.extract-info.outputs.language }}\",
                                  \"short\": true
                                },
                                {
                                  \"title\": \"PR ë§í¬\",
                                  \"value\": \"[PR #${{ github.event.pull_request.number }}](${{ github.event.pull_request.html_url }})\",
                                  \"short\": true
                                }
                              ],
                              \"text\": \"âœ… ìƒ˜í”Œ í…ŒìŠ¤íŠ¸ í†µê³¼\\nğŸ¤– AI ìƒì„± ë°˜ë¡€ í…ŒìŠ¤íŠ¸ í†µê³¼\\nğŸ“Š README.md ìë™ ì—…ë°ì´íŠ¸\\nğŸ‘¥ ìˆ˜ë™ ë³‘í•© ëŒ€ê¸° ì¤‘\"
                            }
                          ]
                        }}"

      # 13. í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì‹œ Mattermost ì•Œë¦¼ ì „ì†¡
      - name: Send Mattermost notification on failure
        if: steps.run-tests.outputs.result == 'FAIL'
        run: |
          curl -X POST "${{ secrets.MATTERMOST_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "{\"payload\": {
              \"channel\": \"algorithm-study\",
              \"username\": \"BOJ-Bot\",
              \"icon_emoji\": \":x:\",
              \"text\": \"âŒ **í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨**\",
              \"attachments\": [
                {
                  \"color\": \"danger\",
                  \"fields\": [
                    {
                      \"title\": \"ë¬¸ì œ ë²ˆí˜¸\",
                      \"value\": \"${{ steps.extract-info.outputs.problem_id }}\",
                      \"short\": true
                    },
                    {
                      \"title\": \"ì œì¶œì\",
                      \"value\": \"${{ steps.extract-info.outputs.author }}\",
                      \"short\": true
                    },
                    {
                      \"title\": \"ì–¸ì–´\",
                      \"value\": \"${{ steps.extract-info.outputs.language }}\",
                      \"short\": true
                    },
                    {
                      \"title\": \"PR ë§í¬\",
                      \"value\": \"[PR #${{ github.event.pull_request.number }}](${{ github.event.pull_request.html_url }})\",
                      \"short\": true
                    }
                  ],
                  \"text\": \"\`\`\`\\n${DETAILS}\\n\`\`\`\\nğŸ’ª ì½”ë“œë¥¼ ìˆ˜ì •í•œ í›„ ë‹¤ì‹œ í‘¸ì‹œí•´ì£¼ì„¸ìš”!\"
                }
              ]
            }}"

      # 14. PRì— í…ŒìŠ¤íŠ¸ ê²°ê³¼ ëŒ“ê¸€ ì‘ì„±
      - name: Comment test results
        if: always()
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { result, details } = ${{ toJSON(steps.run-tests.outputs) }};
            const { problem_id, author } = ${{ toJSON(steps.extract-info.outputs) }};

            if (problem_id === '0000' || author === 'unknown') {
              const body = `## ğŸ“ íŒŒì¼ êµ¬ì¡° ì˜¤ë¥˜\nì˜¬ë°”ë¥¸ íŒŒì¼ êµ¬ì¡°(\`ì´ë¦„/ë¬¸ì œë²ˆí˜¸/Main.java\`)ë¡œ ì œì¶œí•´ì£¼ì„¸ìš”.`;
              await github.rest.issues.createComment({
                issue_number: context.issue.number, owner: context.repo.owner, repo: context.repo.repo, body: body
              });
              return;
            }

            let body;
            if (result === 'PASS') {
              body = `## âœ… í…ŒìŠ¤íŠ¸ í†µê³¼!\nğŸ‰ **${author}**ë‹˜ì˜ ë¬¸ì œ **${problem_id}** í•´ê²°ì„ ì¶•í•˜í•©ë‹ˆë‹¤!\n- âœ… ìƒ˜í”Œ í…ŒìŠ¤íŠ¸: í†µê³¼\n- ğŸ¤– AI ìƒì„± ë°˜ë¡€ í…ŒìŠ¤íŠ¸: í†µê³¼\n- ğŸ“Š README.mdê°€ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.\n\në¸Œëœì¹˜ ë³‘í•©í•˜ê³  ì‚­ì œí•´ì£¼ì„¸ìš”! ğŸš€`;
            } else {
              body = `## âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨\n**${author}**ë‹˜ì˜ ë¬¸ì œ **${problem_id}** ì½”ë“œì—ì„œ ë¬¸ì œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤:\n\`\`\`\n${details}\n\`\`\`\nì½”ë“œë¥¼ ìˆ˜ì •í•œ í›„ ë‹¤ì‹œ í‘¸ì‹œí•´ì£¼ì„¸ìš”! ğŸ’ª`;
            }
            await github.rest.issues.createComment({
              issue_number: context.issue.number, owner: context.repo.owner, repo: context.repo.repo, body: body
            });

  # ë°ë“œë¼ì¸ ì•Œë¦¼ ì‘ì—…
  deadline-reminder:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      - name: Check deadlines and send reminders
        env:
          MATTERMOST_WEBHOOK_URL: ${{ secrets.MATTERMOST_WEBHOOK_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: python scripts/deadline_checker.py