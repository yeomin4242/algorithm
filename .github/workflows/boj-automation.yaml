# ì›Œí¬í”Œë¡œìš° ì´ë¦„: ì•Œê³ ë¦¬ì¦˜ ìŠ¤í„°ë”” ìë™í™” (Approve ê¸°ë°˜)
name: Algorithm Study Automation (Approve Based)

on:
  schedule:
    # KST ê¸°ì¤€ ë§¤ì£¼ ì›”ìš”ì¼ 00:00 (UTC ì¼ìš”ì¼ 15:00)
    - cron: '0 15 * * 0'
  pull_request_target:
    types: [opened, synchronize, reopened]  # submitted ì¶”ê°€ (ë¦¬ë·° ì œì¶œ ì‹œ)
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  actions: write

env:
  TZ: Asia/Seoul
  PYTHON_VERSION: "3.11"
  JAVA_VERSION: "11"
  REPO_OWNER: "yeomin4242"

jobs:
  # í¬í¬ PR ìë™ ìŠ¹ì¸ ë° ì‹¤í–‰
  auto-approve-fork:
    if: github.event_name == 'pull_request_target' && github.event.action != 'submitted' && github.event.pull_request.head.repo.full_name != github.repository
    runs-on: ubuntu-latest
    steps:
      - name: Auto-approve fork PRs
        uses: hmarr/auto-approve-action@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          review-message: "âœ… í¬í¬ëœ ì €ì¥ì†Œì—ì„œì˜ PRì´ ìë™ìœ¼ë¡œ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ì•Œê³ ë¦¬ì¦˜ ìŠ¤í„°ë”” ìë™í™” ì‹œìŠ¤í…œì´ ì‹¤í–‰ë©ë‹ˆë‹¤."

  test-and-update:
    # ìë™ ìŠ¹ì¸ í›„, PR ìƒì„± ì‹œ, ë˜ëŠ” ë¦¬ë·° ì œì¶œ ì‹œ ì‹¤í–‰
    needs: [auto-approve-fork]
    if: always() && (needs.auto-approve-fork.result == 'success' || needs.auto-approve-fork.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - name: Workflow Info
        run: |
          echo "ğŸ”¥ ì•Œê³ ë¦¬ì¦˜ ìŠ¤í„°ë”” ìë™í™” ì›Œí¬í”Œë¡œìš° ì‹œì‘"
          echo "â° ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S KST')"
          echo "ğŸ”§ íŠ¸ë¦¬ê±°: ${{ github.event_name }}"
          echo "ğŸ¬ ì•¡ì…˜: ${{ github.event.action }}"
          if [ "${{ github.event_name }}" = "pull_request_target" ]; then
            echo "ğŸ” Repository: ${{ github.repository }}"
            echo "ğŸŒ¿ Head Repository: ${{ github.event.pull_request.head.repo.full_name }}"
            echo "ğŸŒ¿ Head Ref: ${{ github.event.pull_request.head.ref }}"
            echo "ğŸ‘¤ PR Author: ${{ github.event.pull_request.user.login }}"
            if [ "${{ github.event.action }}" = "submitted" ]; then
              echo "ğŸ“ Review State: ${{ github.event.review.state }}"
              echo "ğŸ‘¥ Reviewer: ${{ github.event.review.user.login }}"
            fi
          fi

      # ë¸Œëœì¹˜ ì „ëµ ê²€ì¦ ë° ê¶Œí•œ í™•ì¸
      - name: Validate Branch Strategy and Permissions
        if: github.event_name == 'pull_request_target'
        id: branch-validation
        run: |
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          AUTHOR="${{ github.event.pull_request.user.login }}"
          HEAD_REPO="${{ github.event.pull_request.head.repo.full_name }}"
          BASE_REPO="${{ github.repository }}"
          REPO_OWNER="${{ env.REPO_OWNER }}"
          ACTION="${{ github.event.action }}"
          
          echo "ğŸ” ë¸Œëœì¹˜ ì „ëµ ê²€ì¦ ì‹œì‘"
          echo "ğŸ“‚ Head Repository: $HEAD_REPO"
          echo "ğŸ“‚ Base Repository: $BASE_REPO"
          echo "ğŸŒ¿ ë¸Œëœì¹˜: $BRANCH_NAME"
          echo "ğŸ‘¤ PR ì‘ì„±ì: $AUTHOR"
          echo "ğŸ‘‘ ì €ì¥ì†Œ ì†Œìœ ì: $REPO_OWNER"
          echo "ğŸ¬ ì•¡ì…˜: $ACTION"
          
          # í¬í¬ ì—¬ë¶€ í™•ì¸
          if [ "$HEAD_REPO" != "$BASE_REPO" ]; then
            echo "ğŸ”€ í¬í¬ëœ ì €ì¥ì†Œì—ì„œì˜ PRì…ë‹ˆë‹¤."
            IS_FORK="true"
          else
            echo "ğŸ“ ì›ë³¸ ì €ì¥ì†Œì—ì„œì˜ PRì…ë‹ˆë‹¤."
            IS_FORK="false"
          fi
          
          # ì €ì¥ì†Œ ì†Œìœ ìì¸ì§€ í™•ì¸
          if [ "$AUTHOR" = "$REPO_OWNER" ]; then
            echo "ğŸ‘‘ ì €ì¥ì†Œ ì†Œìœ ìì˜ PRì…ë‹ˆë‹¤."
            IS_OWNER="true"
          else
            echo "ğŸ‘¤ ì¼ë°˜ ì‚¬ìš©ìì˜ PRì…ë‹ˆë‹¤."
            IS_OWNER="false"
          fi
          
          # ìŠ¹ì¸ ì—¬ë¶€ í™•ì¸ (submitted ì•¡ì…˜ì¸ ê²½ìš°)
          IS_APPROVED="false"
          if [ "$ACTION" = "submitted" ]; then
            REVIEW_STATE="${{ github.event.review.state }}"
            if [ "$REVIEW_STATE" = "approved" ]; then
              echo "âœ… PRì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!"
              IS_APPROVED="true"
            else
              echo "â„¹ï¸ PR ìŠ¹ì¸ì´ ì•„ë‹Œ ë¦¬ë·°ì…ë‹ˆë‹¤: $REVIEW_STATE"
            fi
          fi
          
          # ë¸Œëœì¹˜ ì „ëµ ê²€ì¦
          VALIDATION_RESULT="valid"
          VALIDATION_MESSAGE=""
          
          if [ "$IS_OWNER" = "true" ]; then
            # ì €ì¥ì†Œ ì†Œìœ ìëŠ” ëª¨ë“  ë¸Œëœì¹˜ íŒ¨í„´ í—ˆìš©
            echo "âœ… ì €ì¥ì†Œ ì†Œìœ ìëŠ” ëª¨ë“  ë¸Œëœì¹˜ íŒ¨í„´ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
            WEEK_NUMBER="owner"
            BRANCH_USER="$AUTHOR"
          else
            # ì¼ë°˜ ì‚¬ìš©ìëŠ” week-N-<githubID> íŒ¨í„´ ê°•ì œ
            if [[ $BRANCH_NAME =~ ^week-([0-9]+)-(.+)$ ]]; then
              WEEK_NUMBER="${BASH_REMATCH[1]}"
              BRANCH_USER="${BASH_REMATCH[2]}"
              
              echo "âœ… ì˜¬ë°”ë¥¸ ë¸Œëœì¹˜ íŒ¨í„´ì…ë‹ˆë‹¤. (week-$WEEK_NUMBER-$BRANCH_USER)"
              
              # í¬í¬ í™˜ê²½ì—ì„œëŠ” ë¸Œëœì¹˜ ì‚¬ìš©ìì™€ PR ì‘ì„±ì ì¼ì¹˜ í™•ì¸
              if [ "$IS_FORK" = "true" ]; then
                if [ "$BRANCH_USER" = "$AUTHOR" ]; then
                  echo "âœ… í¬í¬ í™˜ê²½: ë¸Œëœì¹˜ ì‚¬ìš©ìì™€ PR ì‘ì„±ìê°€ ì¼ì¹˜í•©ë‹ˆë‹¤."
                else
                  echo "âŒ í¬í¬ í™˜ê²½: ë¸Œëœì¹˜ ì‚¬ìš©ì($BRANCH_USER)ì™€ PR ì‘ì„±ì($AUTHOR)ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
                  VALIDATION_RESULT="invalid"
                  VALIDATION_MESSAGE="í¬í¬ í™˜ê²½ì—ì„œëŠ” ìì‹ ì˜ GitHub IDë¡œ ë¸Œëœì¹˜ë¥¼ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤."
                fi
              else
                echo "âœ… ì›ë³¸ ì €ì¥ì†Œ: í˜‘ì—…ìê°€ ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ë¸Œëœì¹˜ë¥¼ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
              fi
            else
              echo "âŒ ì¼ë°˜ ì‚¬ìš©ìëŠ” week-N-<githubID> íŒ¨í„´ì„ ë”°ë¼ì•¼ í•©ë‹ˆë‹¤."
              echo "ğŸ’¡ ì˜¬ë°”ë¥¸ ì˜ˆì‹œ: week-1-$AUTHOR, week-2-$AUTHOR"
              VALIDATION_RESULT="invalid"
              VALIDATION_MESSAGE="ë¸Œëœì¹˜ ì´ë¦„ì´ week-N-<githubID> íŒ¨í„´ì„ ë”°ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."
            fi
          fi
          
          # ê²°ê³¼ ì¶œë ¥
          echo "valid=$VALIDATION_RESULT" >> $GITHUB_OUTPUT
          echo "is_fork=$IS_FORK" >> $GITHUB_OUTPUT
          echo "is_owner=$IS_OWNER" >> $GITHUB_OUTPUT
          echo "is_approved=$IS_APPROVED" >> $GITHUB_OUTPUT
          echo "week_number=$WEEK_NUMBER" >> $GITHUB_OUTPUT
          echo "branch_user=$BRANCH_USER" >> $GITHUB_OUTPUT
          echo "validation_message=$VALIDATION_MESSAGE" >> $GITHUB_OUTPUT

      # ë¸Œëœì¹˜ ê²€ì¦ ì‹¤íŒ¨ ì‹œ PRì— ê°€ì´ë“œ ì½”ë©˜íŠ¸
      - name: Comment on Invalid Branch Strategy
        if: github.event_name == 'pull_request_target' && github.event.action != 'submitted' && steps.branch-validation.outputs.valid == 'invalid'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branchName = '${{ github.event.pull_request.head.ref }}';
            const author = '${{ github.event.pull_request.user.login }}';
            const isFork = '${{ steps.branch-validation.outputs.is_fork }}' === 'true';
            const isOwner = '${{ steps.branch-validation.outputs.is_owner }}' === 'true';
            const validationMessage = '${{ steps.branch-validation.outputs.validation_message }}';
            const headRepo = '${{ github.event.pull_request.head.repo.full_name }}';
            const repoOwner = '${{ env.REPO_OWNER }}';
            
            let commentBody = `## âš ï¸ ë¸Œëœì¹˜ ì „ëµ ê²€ì¦ ì‹¤íŒ¨\n\n`;
            commentBody += `í˜„ì¬ ë¸Œëœì¹˜: \`${branchName}\`\n`;
            commentBody += `PR ì‘ì„±ì: \`${author}\`\n`;
            commentBody += `ì €ì¥ì†Œ íƒ€ì…: ${isFork ? 'ğŸ”€ í¬í¬ëœ ì €ì¥ì†Œ' : 'ğŸ“ ì›ë³¸ ì €ì¥ì†Œ'}\n`;
            commentBody += `ê¶Œí•œ: ${isOwner ? 'ğŸ‘‘ ì €ì¥ì†Œ ì†Œìœ ì' : 'ğŸ‘¤ ì¼ë°˜ ì‚¬ìš©ì'}\n\n`;
            
            commentBody += `âŒ **ë¬¸ì œ**: ${validationMessage}\n\n`;
            
            if (!isOwner) {
              commentBody += `### ğŸ“ ì¼ë°˜ ì‚¬ìš©ì ë¸Œëœì¹˜ ê·œì¹™\n`;
              commentBody += `- **íŒ¨í„´**: \`week-N-<githubID>\`\n`;
              commentBody += `- **ì˜ˆì‹œ**: \`week-1-${author}\`, \`week-2-${author}\`\n\n`;
              
              if (isFork) {
                commentBody += `### ğŸ”§ í¬í¬ í™˜ê²½ì—ì„œì˜ í•´ê²° ë°©ë²•\n`;
                commentBody += `í¬í¬ëœ ì €ì¥ì†Œ(\`${headRepo}\`)ì—ì„œ ë‹¤ìŒ ëª…ë ¹ì„ ì‹¤í–‰í•˜ì„¸ìš”:\n\n`;
                commentBody += `\`\`\`bash\n`;
                commentBody += `# ì˜¬ë°”ë¥¸ ë¸Œëœì¹˜ ì´ë¦„ìœ¼ë¡œ ë³€ê²½\n`;
                commentBody += `git branch -m ${branchName} week-1-${author}\n\n`;
                commentBody += `# ìƒˆ ë¸Œëœì¹˜ ì´ë¦„ìœ¼ë¡œ í‘¸ì‹œ\n`;
                commentBody += `git push origin week-1-${author}\n\n`;
                commentBody += `# ê¸°ì¡´ ë¸Œëœì¹˜ ì‚­ì œ\n`;
                commentBody += `git push origin --delete ${branchName}\n`;
                commentBody += `\`\`\`\n\n`;
                commentBody += `ê·¸ í›„ ìƒˆë¡œìš´ PRì„ ìƒì„±í•´ì£¼ì„¸ìš”.`;
              }
            }

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

      # ì•ˆì „í•œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Code (Safe for Forks)
        if: github.event_name != 'pull_request_target' || steps.branch-validation.outputs.valid == 'valid'
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.base.ref || github.ref }}
          fetch-depth: 0

      # PR ë³€ê²½ì‚¬í•­ ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜¤ê¸°
      - name: Fetch PR Changes (For Fork Safety)
        if: github.event_name == 'pull_request_target' && steps.branch-validation.outputs.valid == 'valid'
        run: |
          echo "ğŸ”„ PR ë³€ê²½ì‚¬í•­ì„ ì•ˆì „í•˜ê²Œ ê°€ì ¸ì˜µë‹ˆë‹¤..."
          git remote add pr-head ${{ github.event.pull_request.head.repo.clone_url }}
          git fetch pr-head ${{ github.event.pull_request.head.ref }}:pr-branch
          git checkout pr-branch
          echo "âœ… PR ë¸Œëœì¹˜ë¡œ ì²´í¬ì•„ì›ƒ ì™„ë£Œ"

      - name: Setup Python and Java
        if: github.event_name != 'pull_request_target' || steps.branch-validation.outputs.valid == 'valid'
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Setup Java
        if: github.event_name != 'pull_request_target' || steps.branch-validation.outputs.valid == 'valid'
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: "temurin"

      - name: Install Python dependencies
        if: github.event_name != 'pull_request_target' || steps.branch-validation.outputs.valid == 'valid'
        run: |
          python -m pip install --upgrade pip
          pip install google-genai pytz requests beautifulsoup4

      # =================================================================
      #  PR í…ŒìŠ¤íŠ¸ ë¡œì§ (PR ìƒì„± ì‹œì—ë§Œ ì‹¤í–‰)
      # =================================================================
      - name: Run PR Logic - Extract & Test
        if: github.event_name == 'pull_request_target' && github.event.action != 'submitted' && steps.branch-validation.outputs.valid == 'valid'
        id: pr-test
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          WEEK_NUMBER: ${{ steps.branch-validation.outputs.week_number }}
          BRANCH_USER: ${{ steps.branch-validation.outputs.branch_user }}
          IS_OWNER: ${{ steps.branch-validation.outputs.is_owner }}
        run: |
          if [ "$IS_OWNER" = "true" ]; then
            echo "ğŸ‘‘ ì €ì¥ì†Œ ì†Œìœ ìì˜ ì†”ë£¨ì…˜ì„ ë¶„ì„í•©ë‹ˆë‹¤."
          else
            echo "ğŸ“… ì£¼ì°¨ $WEEK_NUMBERì˜ $BRANCH_USERë‹˜ì˜ ì†”ë£¨ì…˜ì„ ë¶„ì„í•©ë‹ˆë‹¤."
          fi
          
          python scripts/extract_pr_info.py
          if [ -f "problems_info.json" ]; then
            python scripts/multi_test_runner.py
          else
            echo "í…ŒìŠ¤íŠ¸í•  ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤."
          fi
        continue-on-error: true

      - name: Run PR Logic - Analyze Results
        if: github.event_name == 'pull_request_target' && github.event.action != 'submitted' && steps.branch-validation.outputs.valid == 'valid' && steps.pr-test.outcome != 'skipped'
        id: analyze-results
        run: python scripts/analyze_test_results.py

      - name: Run PR Logic - Post Test Results Comment
        if: github.event_name == 'pull_request_target' && github.event.action != 'submitted' && steps.branch-validation.outputs.valid == 'valid' && steps.analyze-results.outcome == 'success'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const weekNumber = '${{ steps.branch-validation.outputs.week_number }}';
            const branchUser = '${{ steps.branch-validation.outputs.branch_user }}';
            const isOwner = '${{ steps.branch-validation.outputs.is_owner }}' === 'true';
            const isFork = '${{ steps.branch-validation.outputs.is_fork }}' === 'true';
            
            // íŒŒì¼ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
            if (!fs.existsSync('test_results_summary.json')) {
              console.log('test_results_summary.json íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
              return;
            }
            
            const results = JSON.parse(fs.readFileSync('test_results_summary.json', 'utf8'));
            const { overall_success, passed_problems, partial_passed_problems, failed_problems, total_problems } = results;
            
            let commentBody = `## ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½\n\n`;
            
            if (isOwner) {
              commentBody += `### ğŸ‘‘ ì €ì¥ì†Œ ì†Œìœ ì ì œì¶œ\n`;
            } else {
              commentBody += `### Week ${weekNumber} - ${branchUser}ë‹˜ì˜ ì œì¶œ\n`;
            }
            
            commentBody += `| ì „ì²´ | âœ… ì„±ê³µ | âš ï¸ ë¶€ë¶„ ì„±ê³µ | âŒ ì‹¤íŒ¨ |\n`;
            commentBody += `|:---:|:---:|:---:|:---:|\n`;
            commentBody += `| ${total_problems}ê°œ | ${passed_problems}ê°œ | ${partial_passed_problems}ê°œ | ${failed_problems}ê°œ |\n\n`;
            
            commentBody += `### ğŸ“‹ ì œì¶œ ì •ë³´\n`;
            commentBody += `- **ì œì¶œì**: ${branchUser} ${isOwner ? '(ì €ì¥ì†Œ ì†Œìœ ì)' : ''}\n`;
            if (!isOwner) {
              commentBody += `- **ì£¼ì°¨**: Week ${weekNumber}\n`;
            }
            commentBody += `- **ë¸Œëœì¹˜**: \`${{ github.event.pull_request.head.ref }}\`\n`;
            commentBody += `- **ì €ì¥ì†Œ**: ${isFork ? 'ğŸ”€ í¬í¬ëœ ì €ì¥ì†Œ' : 'ğŸ“ ì›ë³¸ ì €ì¥ì†Œ'}\n\n`;
            
            commentBody += `### ğŸ¯ ë‹¤ìŒ ë‹¨ê³„\n`;
            commentBody += `âœ… **ì´ PRì„ approveí•˜ë©´ READMEê°€ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤!**\n\n`;
            
            commentBody += `---\nğŸ‰ **í…ŒìŠ¤íŠ¸ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!** PRì„ ìŠ¹ì¸í•˜ë©´ ì œì¶œ í˜„í™©ì´ READMEì— ë°˜ì˜ë©ë‹ˆë‹¤.`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

      # =================================================================
      #  README ì—…ë°ì´íŠ¸ ë¡œì§ (Approve ì‹œì—ë§Œ ì‹¤í–‰)
      # =================================================================
      - name: Update README on Approve
        if: github.event_name == 'pull_request_target' && github.event.action == 'submitted' && steps.branch-validation.outputs.is_approved == 'true' && steps.branch-validation.outputs.valid == 'valid'
        env:
          WEEK_NUMBER: ${{ steps.branch-validation.outputs.week_number }}
          BRANCH_USER: ${{ steps.branch-validation.outputs.branch_user }}
          IS_OWNER: ${{ steps.branch-validation.outputs.is_owner }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          if [ "$IS_OWNER" = "true" ]; then
            echo "ğŸ‘‘ ì €ì¥ì†Œ ì†Œìœ ìì˜ PRì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. READMEë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤."
          else
            echo "âœ… Week $WEEK_NUMBER - $BRANCH_USERë‹˜ì˜ PRì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. READMEë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤."
          fi
          
          # PRì˜ ë³€ê²½ëœ íŒŒì¼ë“¤ì„ ë¶„ì„
          echo "ğŸ” PRì˜ ë³€ê²½ì‚¬í•­ì„ ë¶„ì„í•©ë‹ˆë‹¤..."
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/vnd.github.v3+json" \
               "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/files" \
               > pr_files.json
          
          # ë¨¸ì§€ëœ PR ë¶„ì„ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          if [ -f "scripts/analyze_merged_pr.py" ]; then
            echo "ğŸ“Š PR íŒŒì¼ ë¶„ì„ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤."
            python scripts/analyze_merged_pr.py
          else
            echo "âš ï¸ analyze_merged_pr.py ìŠ¤í¬ë¦½íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤."
          fi
          
          # README ì—…ë°ì´íŠ¸ ìˆ˜í–‰
          if [ -f "problems_info.json" ] && [ -f "scripts/update_readme_batch.py" ]; then
            echo "ğŸ“ README ì—…ë°ì´íŠ¸ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤."
            python scripts/update_readme_batch.py || {
              echo "âŒ README ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ ë°œìƒí–ˆì§€ë§Œ ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤."
            }
          else
            echo "âš ï¸ í•„ìš”í•œ íŒŒì¼ì´ ì—†ì–´ README ì—…ë°ì´íŠ¸ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
          fi

      - name: Commit README Changes on Approve
        if: github.event_name == 'pull_request_target' && github.event.action == 'submitted' && steps.branch-validation.outputs.is_approved == 'true' && steps.branch-validation.outputs.valid == 'valid'
        env:
          WEEK_NUMBER: ${{ steps.branch-validation.outputs.week_number }}
          BRANCH_USER: ${{ steps.branch-validation.outputs.branch_user }}
          IS_OWNER: ${{ steps.branch-validation.outputs.is_owner }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # main ë¸Œëœì¹˜ë¡œ ì²´í¬ì•„ì›ƒ
          git checkout main
          git pull origin main
          
          # ë™ì¼í•œ ë¶„ì„ì„ main ë¸Œëœì¹˜ì—ì„œ ìˆ˜í–‰
          if [ -f "pr_files.json" ] && [ -f "scripts/analyze_merged_pr.py" ]; then
            python scripts/analyze_merged_pr.py
          fi
          
          if [ -f "problems_info.json" ] && [ -f "scripts/update_readme_batch.py" ]; then
            python scripts/update_readme_batch.py || echo "README ì—…ë°ì´íŠ¸ ì‹¤íŒ¨í–ˆì§€ë§Œ ê³„ì† ì§„í–‰"
          fi
          
          # Git ì„¤ì • ë° ì»¤ë°‹
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"
          
          if ! git diff --quiet README.md; then
            echo "ğŸ“ README.md ë³€ê²½ì‚¬í•­ì„ ì»¤ë°‹í•©ë‹ˆë‹¤."
            
            # ì»¤ë°‹ ë©”ì‹œì§€ êµ¬ì„±
            if [ "$IS_OWNER" = "true" ]; then
              COMMIT_MSG="docs: Update README.md after approving owner's PR #$PR_NUMBER"
            else
              COMMIT_MSG="docs: Update README.md for week-$WEEK_NUMBER by $BRANCH_USER (approved PR #$PR_NUMBER)"
            fi
            
            git add README.md
            git commit -m "$COMMIT_MSG"
            git push origin main
            echo "âœ… README ì—…ë°ì´íŠ¸ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
          else
            echo "â„¹ï¸ README.mdì— ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
          fi

      - name: Post Approve Success Comment
        if: github.event_name == 'pull_request_target' && github.event.action == 'submitted' && steps.branch-validation.outputs.is_approved == 'true' && steps.branch-validation.outputs.valid == 'valid'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const weekNumber = '${{ steps.branch-validation.outputs.week_number }}';
            const branchUser = '${{ steps.branch-validation.outputs.branch_user }}';
            const isOwner = '${{ steps.branch-validation.outputs.is_owner }}' === 'true';
            
            let commentBody = `## ğŸ‰ README ì—…ë°ì´íŠ¸ ì™„ë£Œ!\n\n`;
            
            if (isOwner) {
              commentBody += `ğŸ‘‘ **ì €ì¥ì†Œ ì†Œìœ ìì˜ ì œì¶œì´ ìŠ¹ì¸ë˜ì–´ READMEê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.**\n\n`;
            } else {
              commentBody += `âœ… **Week ${weekNumber} - ${branchUser}ë‹˜ì˜ ì œì¶œì´ ìŠ¹ì¸ë˜ì–´ READMEê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.**\n\n`;
            }
            
            commentBody += `### ğŸ“ ë³€ê²½ì‚¬í•­\n`;
            commentBody += `- âœ… ì œì¶œ í˜„í™©ì´ READMEì— ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤\n`;
            commentBody += `- ğŸ“Š ë¬¸ì œ í•´ê²° ê¸°ë¡ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤\n\n`;
            commentBody += `ì´ì œ ì´ PRì„ ì•ˆì „í•˜ê²Œ ë¨¸ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤! ğŸš€`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

      - name: Send Mattermost DM Notification
        if: github.event_name == 'pull_request_target' && github.event.action != 'submitted' && steps.branch-validation.outputs.valid == 'valid' && always() && steps.analyze-results.outcome != 'skipped'
        env:
          PERSONAL_WEBHOOK_URL: ${{ secrets[format('{0}_MATTERMOST_URL', steps.branch-validation.outputs.branch_user)] }}
          WEEK_NUMBER: ${{ steps.branch-validation.outputs.week_number }}
          BRANCH_USER: ${{ steps.branch-validation.outputs.branch_user }}
          IS_OWNER: ${{ steps.branch-validation.outputs.is_owner }}
        run: |
          if [ -n "$PERSONAL_WEBHOOK_URL" ]; then
            if [ "${{ steps.analyze-results.outputs.overall_result }}" = "PASS" ]; then
              if [ "$IS_OWNER" = "true" ]; then
                echo "âœ… ì €ì¥ì†Œ ì†Œìœ ì í…ŒìŠ¤íŠ¸ ì„±ê³µ! ì„±ê³µ ì•Œë¦¼ì„ ì „ì†¡í•©ë‹ˆë‹¤."
              else
                echo "âœ… Week $WEEK_NUMBER - $BRANCH_USERë‹˜ í…ŒìŠ¤íŠ¸ ì„±ê³µ! ì„±ê³µ ì•Œë¦¼ì„ ì „ì†¡í•©ë‹ˆë‹¤."
              fi
              python scripts/send_success_notification.py "${{ github.event.pull_request.html_url }}" "$BRANCH_USER" "$PERSONAL_WEBHOOK_URL" || echo "ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨"
            else
              if [ "$IS_OWNER" = "true" ]; then
                echo "âŒ ì €ì¥ì†Œ ì†Œìœ ì í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨! ì‹¤íŒ¨ ì•Œë¦¼ì„ ì „ì†¡í•©ë‹ˆë‹¤."
              else
                echo "âŒ Week $WEEK_NUMBER - $BRANCH_USERë‹˜ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨! ì‹¤íŒ¨ ì•Œë¦¼ì„ ì „ì†¡í•©ë‹ˆë‹¤."
              fi
              python scripts/send_failure_notification.py "${{ github.event.pull_request.html_url }}" "$BRANCH_USER" "$PERSONAL_WEBHOOK_URL" || echo "ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨"
            fi
          else
            echo "âš ï¸ $BRANCH_USERë‹˜ì˜ Mattermost ì›¹í›… URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          fi

      # =================================================================
      #  ì£¼ê°„ ì‹¤í–‰ ë¡œì§
      # =================================================================
      - name: Run Weekly Logic - Reset README for New Week
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: |
          echo "ğŸ“… ìƒˆë¡œìš´ ì£¼ì°¨ë¥¼ ìœ„í•´ READMEë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤."
          python scripts/weekly_reset.py --force

      - name: Run Weekly Logic - Commit and Push to main
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"
          if ! git diff --quiet README.md; then
            echo "README.md ë³€ê²½ì‚¬í•­ì„ main ë¸Œëœì¹˜ì— ì»¤ë°‹í•©ë‹ˆë‹¤."
            git add README.md
            git commit -m "chore: ì£¼ê°„ README ì´ˆê¸°í™”"
            git push origin main
          else
            echo "README.mdì— ë³€ê²½ì‚¬í•­ì´ ì—†ì–´ ì»¤ë°‹í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
          fi