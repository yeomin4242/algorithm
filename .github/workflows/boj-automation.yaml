# ì›Œí¬í”Œë¡œìš° ì´ë¦„: ì•Œê³ ë¦¬ì¦˜ ìŠ¤í„°ë”” ìë™í™” (Approve ê¸°ë°˜)
# ë‘ ê°€ì§€ PR ì „ëµ ì§€ì› (ëª¨ë‘ week-N-<githubID> ë¸Œëœì¹˜ ê·œì¹™ ì ìš©):
# 1. ì†Œìœ ì(yeomin4242)ê°€ ì›ë³¸ ì €ì¥ì†Œì—ì„œ ì§ì ‘ ë¸Œëœì¹˜ë¥¼ ìƒì„±í•˜ê³  PR -> ì›ë³¸ ì €ì¥ì†Œ README ì—…ë°ì´íŠ¸
# 2. ì™¸ë¶€ ê¸°ì—¬ìê°€ ì›ë³¸ ì €ì¥ì†Œë¥¼ í¬í¬(Fork)í•œ í›„, ìì‹ ì˜ ì €ì¥ì†Œì—ì„œ PR -> ì›ë³¸ ì €ì¥ì†Œ README ì—…ë°ì´íŠ¸
name: Algorithm Study Automation (Approve Based)

on:
  schedule:
    # KST ê¸°ì¤€ ë§¤ì£¼ ì›”ìš”ì¼ 00:00 (UTC ì¼ìš”ì¼ 15:00)
    - cron: '0 15 * * 0'
  pull_request_target:
    types: [opened, synchronize, reopened]
    branches: [main]
  pull_request_review:
    types: [submitted]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  actions: write

env:
  TZ: Asia/Seoul
  PYTHON_VERSION: "3.11"
  JAVA_VERSION: "11"
  REPO_OWNER: "yeomin4242"

jobs:
  # í¬í¬ PR ìë™ ìŠ¹ì¸ (ì „ëµ 2: ì™¸ë¶€ ê¸°ì—¬ì PRì—ë§Œ í•´ë‹¹)
  auto-approve-fork:
    if: github.event_name == 'pull_request_target' && github.event.pull_request.head.repo.full_name != github.repository
    runs-on: ubuntu-latest
    steps:
      - name: Auto-approve fork PRs
        uses: hmarr/auto-approve-action@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          review-message: "âœ… í¬í¬ëœ ì €ì¥ì†Œì—ì„œì˜ PRì´ ìë™ìœ¼ë¡œ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ì•Œê³ ë¦¬ì¦˜ ìŠ¤í„°ë”” ìë™í™” ì‹œìŠ¤í…œì´ ì‹¤í–‰ë©ë‹ˆë‹¤."

  # PR í…ŒìŠ¤íŠ¸ ë° README ì—…ë°ì´íŠ¸ ì‘ì—…
  test-and-update:
    needs: [auto-approve-fork]
    if: always() # auto-approve-fork ì‘ì—…ì˜ ê²°ê³¼ì™€ ìƒê´€ì—†ì´ í•­ìƒ ì‹¤í–‰
    runs-on: ubuntu-latest
    steps:
      # =================================================================
      #  ê³µí†µ ì„¤ì • ë° ì •ë³´ ì¶œë ¥
      # =================================================================
      - name: Workflow Info
        run: |
          echo "ğŸ”¥ ì•Œê³ ë¦¬ì¦˜ ìŠ¤í„°ë”” ìë™í™” ì›Œí¬í”Œë¡œìš° ì‹œì‘"
          echo "â° ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S KST')"
          echo "ğŸ”§ íŠ¸ë¦¬ê±°: ${{ github.event_name }}"
          # ... (ì´í•˜ ì •ë³´ ì¶œë ¥ ìŠ¤í¬ë¦½íŠ¸ëŠ” ê¸°ì¡´ê³¼ ë™ì¼)

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: "temurin"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install google-genai pytz requests beautifulsoup4

      # =================================================================
      #  ë¸Œëœì¹˜ ì „ëµ ê²€ì¦ (ëª¨ë“  PR ê´€ë ¨ ì´ë²¤íŠ¸ì—ì„œ ì‹¤í–‰)
      # =================================================================
      - name: Validate Branch Strategy and Permissions
        if: github.event_name == 'pull_request_target' || github.event_name == 'pull_request_review'
        id: branch-validation
        run: |
          # PR ê´€ë ¨ ì •ë³´ë¥¼ í™˜ê²½ ë³€ìˆ˜ë¡œë¶€í„° ì½ì–´ì˜µë‹ˆë‹¤.
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          AUTHOR="${{ github.event.pull_request.user.login }}"
          HEAD_REPO="${{ github.event.pull_request.head.repo.full_name }}"
          BASE_REPO="${{ github.repository }}"
          EVENT_NAME="${{ github.event_name }}"
          
          IS_FORK="false"
          if [ "$HEAD_REPO" != "$BASE_REPO" ]; then IS_FORK="true"; fi
          
          IS_OWNER="false"
          if [ "$AUTHOR" = "${{ env.REPO_OWNER }}" ]; then IS_OWNER="true"; fi
          
          IS_APPROVED="false"
          if [ "$EVENT_NAME" = "pull_request_review" ] && [ "${{ github.event.review.state }}" = "approved" ]; then
            IS_APPROVED="true"
          fi
          
          # --- ë¸Œëœì¹˜ ê·œì¹™ ê²€ì¦ (ì†Œìœ ì í¬í•¨ ëª¨ë“  ì‚¬ìš©ìì—ê²Œ ì ìš©) ---
          VALIDATION_RESULT="invalid" # ê¸°ë³¸ì ìœ¼ë¡œ ìœ íš¨í•˜ì§€ ì•Šë‹¤ê³  ê°€ì •
          WEEK_NUMBER=""
          BRANCH_USER=""

          if [[ $BRANCH_NAME =~ ^week-([0-9]+)-(.+)$ ]]; then
            # íŒ¨í„´ì´ ì¼ì¹˜í•˜ë©´, ì£¼ì°¨ì™€ ì‚¬ìš©ì IDë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤.
            WEEK_NUMBER="${BASH_REMATCH[1]}"
            BRANCH_USER="${BASH_REMATCH[2]}"
            
            # í¬í¬ëœ ì €ì¥ì†Œì—ì„œ ì˜¨ PR(ì „ëµ 2)ì˜ ê²½ìš°, ì¶”ê°€ ê²€ì¦ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.
            if [ "$IS_FORK" = "true" ] && [ "$BRANCH_USER" != "$AUTHOR" ]; then
              # ë¸Œëœì¹˜ì— ëª…ì‹œëœ ì‚¬ìš©ì IDì™€ PR ì‘ì„±ìê°€ ë‹¤ë¥´ë©´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
              VALIDATION_MESSAGE="í¬í¬ í™˜ê²½ì—ì„œëŠ” ë¸Œëœì¹˜ ì´ë¦„ì˜ GitHub ID('<githubID>')ê°€ ë³¸ì¸ì˜ IDì™€ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤."
            else
              # íŒ¨í„´ì´ ì¼ì¹˜í•˜ê³ , (í•„ìš”ì‹œ) í¬í¬ ê²€ì¦ì„ í†µê³¼í•˜ë©´ ìœ íš¨í•©ë‹ˆë‹¤.
              VALIDATION_RESULT="valid"
              VALIDATION_MESSAGE="âœ… ì˜¬ë°”ë¥¸ ë¸Œëœì¹˜ íŒ¨í„´ì…ë‹ˆë‹¤."
            fi
          else
            # íŒ¨í„´ ìì²´ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠëŠ” ê²½ìš°
            VALIDATION_MESSAGE="ë¸Œëœì¹˜ ì´ë¦„ì´ week-N-<githubID> íŒ¨í„´ì„ ë”°ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (ì˜ˆ: week-1-${AUTHOR})"
          fi
          
          # ê²€ì¦ ê²°ê³¼ë¥¼ ë‹¤ìŒ ìŠ¤í…ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì¶œë ¥ ë³€ìˆ˜ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
          echo "valid=$VALIDATION_RESULT" >> $GITHUB_OUTPUT
          echo "is_fork=$IS_FORK" >> $GITHUB_OUTPUT
          echo "is_owner=$IS_OWNER" >> $GITHUB_OUTPUT
          echo "is_approved=$IS_APPROVED" >> $GITHUB_OUTPUT
          echo "week_number=$WEEK_NUMBER" >> $GITHUB_OUTPUT
          echo "branch_user=$BRANCH_USER" >> $GITHUB_OUTPUT
          echo "validation_message=$VALIDATION_MESSAGE" >> $GITHUB_OUTPUT

      - name: Comment on Invalid Branch Strategy
        if: github.event_name == 'pull_request_target' && steps.branch-validation.outputs.valid == 'invalid'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            const branchName = '${{ github.event.pull_request.head.ref }}';
            const author = '${{ github.event.pull_request.user.login }}';
            const validationMessage = '${{ steps.branch-validation.outputs.validation_message }}';
            
            let commentBody = `## âš ï¸ ë¸Œëœì¹˜ ì „ëµ ê²€ì¦ ì‹¤íŒ¨\n\n`;
            commentBody += `âŒ **ë¬¸ì œ**: ${validationMessage}\n\n`;
            commentBody += `### ğŸ“ ë¸Œëœì¹˜ ê·œì¹™\n`;
            commentBody += `- **íŒ¨í„´**: \`week-N-<githubID>\`\n`;
            commentBody += `- **ì˜ˆì‹œ**: \`week-1-${author}\`\n\n`;
            commentBody += `í˜„ì¬ ë¸Œëœì¹˜(\`${branchName}\`)ë¥¼ ì˜¬ë°”ë¥¸ íŒ¨í„´ìœ¼ë¡œ ìˆ˜ì •í•˜ê³  ë‹¤ì‹œ PRì„ ë³´ë‚´ì£¼ì„¸ìš”.`;

            await github.rest.issues.createComment({ owner, repo, issue_number, body: commentBody });

      # =================================================================
      #  PR í…ŒìŠ¤íŠ¸ ë¡œì§ (PR ìƒì„±/ìˆ˜ì • ì‹œì—ë§Œ ì‹¤í–‰)
      # =================================================================
      - name: Checkout PR Code for Testing
        if: github.event_name == 'pull_request_target' && steps.branch-validation.outputs.valid == 'valid'
        uses: actions/checkout@v4
        with:
          # PRì„ ë³´ë‚¸ ì‚¬ëŒì˜ ì €ì¥ì†Œ(ì›ë³¸ ë˜ëŠ” í¬í¬)ì™€ ë¸Œëœì¹˜ë¥¼ ì§ì ‘ ì²´í¬ì•„ì›ƒí•©ë‹ˆë‹¤.
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Run PR Logic - Extract & Test
        if: github.event_name == 'pull_request_target' && steps.branch-validation.outputs.valid == 'valid'
        id: pr-test
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          WEEK_NUMBER: ${{ steps.branch-validation.outputs.week_number }}
          BRANCH_USER: ${{ steps.branch-validation.outputs.branch_user }}
        run: |
          python scripts/extract_pr_info.py
          if [ -f "problems_info.json" ]; then
            python scripts/multi_test_runner.py
          else
            echo "í…ŒìŠ¤íŠ¸í•  ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤."
          fi
        continue-on-error: true

      - name: Run PR Logic - Analyze Results
        if: github.event_name == 'pull_request_target' && steps.branch-validation.outputs.valid == 'valid' && steps.pr-test.outcome != 'skipped'
        id: analyze-results
        run: python scripts/analyze_test_results.py

      - name: Run PR Logic - Post Test Results Comment
        if: github.event_name == 'pull_request_target' && steps.branch-validation.outputs.valid == 'valid' && steps.pr-test.outcome != 'skipped'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            if (!fs.existsSync('test_results_summary.json')) {
              console.log('test_results_summary.json íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
              return;
            }
            const results = JSON.parse(fs.readFileSync('test_results_summary.json', 'utf8'));
            const { passed_problems, partial_passed_problems, failed_problems, total_problems } = results;
            const weekNumber = '${{ steps.branch-validation.outputs.week_number }}';
            const branchUser = '${{ steps.branch-validation.outputs.branch_user }}';
            
            let commentBody = `## ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½ (Week ${weekNumber} - ${branchUser})\n\n`;
            commentBody += `| ì „ì²´ | âœ… ì„±ê³µ | âš ï¸ ë¶€ë¶„ ì„±ê³µ | âŒ ì‹¤íŒ¨ |\n`;
            commentBody += `|:---:|:---:|:---:|:---:|\n`;
            commentBody += `| ${total_problems}ê°œ | ${passed_problems}ê°œ | ${partial_passed_problems}ê°œ | ${failed_problems}ê°œ |\n\n`;
            commentBody += `### ğŸ¯ ë‹¤ìŒ ë‹¨ê³„\n`;
            commentBody += `âœ… **ì´ PRì„ approveí•˜ë©´ ì›ë³¸ ì €ì¥ì†Œì˜ READMEê°€ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤!**\n\n`;
            commentBody += `---\nğŸ‰ **í…ŒìŠ¤íŠ¸ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!**`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });

      # =================================================================
      #  README ì—…ë°ì´íŠ¸ ë¡œì§ (Approve ì‹œì—ë§Œ ì‹¤í–‰)
      # =================================================================
      - name: Checkout Base Repo for README update
        if: github.event_name == 'pull_request_review' && steps.branch-validation.outputs.is_approved == 'true' && steps.branch-validation.outputs.valid == 'valid'
        uses: actions/checkout@v4
        with:
          # README ì—…ë°ì´íŠ¸ëŠ” í•­ìƒ ì›ë³¸ ì €ì¥ì†Œì—ì„œ ìˆ˜í–‰í•©ë‹ˆë‹¤.
          repository: ${{ github.repository }}
          ref: 'main'
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate analysis file from PR
        if: github.event_name == 'pull_request_review' && steps.branch-validation.outputs.is_approved == 'true' && steps.branch-validation.outputs.valid == 'valid'
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WEEK_NUMBER: ${{ steps.branch-validation.outputs.week_number }}
          BRANCH_USER: ${{ steps.branch-validation.outputs.branch_user }}
        run: |
          echo "ğŸ” PR #${PR_NUMBER}ì˜ ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ì„ APIë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤..."
          curl -s -H "Authorization: token $GITHUB_TOKEN" \
               -H "Accept: application/vnd.github.v3+json" \
               "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/files" \
               > pr_files.json
          echo "ğŸ“Š pr_files.jsonì„ ê¸°ë°˜ìœ¼ë¡œ problems_info.jsonì„ ìƒì„±í•©ë‹ˆë‹¤."
          python scripts/analyze_merged_pr.py

      - name: Update README.md file
        if: github.event_name == 'pull_request_review' && steps.branch-validation.outputs.is_approved == 'true' && steps.branch-validation.outputs.valid == 'valid'
        env:
          WEEK_NUMBER: ${{ steps.branch-validation.outputs.week_number }}
          BRANCH_USER: ${{ steps.branch-validation.outputs.branch_user }}
          IS_OWNER: ${{ steps.branch-validation.outputs.is_owner }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          if [ -f "problems_info.json" ] && [ -f "scripts/update_readme_batch.py" ]; then
            echo "ğŸ“ README.md ì—…ë°ì´íŠ¸ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤."
            python scripts/update_readme_batch.py
          else
            echo "âš ï¸ README ì—…ë°ì´íŠ¸ì— í•„ìš”í•œ íŒŒì¼ì´ ì—†ì–´ Fallback ë¡œì§ì„ ì‹¤í–‰í•©ë‹ˆë‹¤."
            cat >> README.md << EOF

            ## ğŸ“‹ Week ${WEEK_NUMBER} - ${BRANCH_USER} (Fallback)
            - **PR #${PR_NUMBER}** approved at $(date)
            - âœ… Submission complete
            EOF
          fi

      - name: Generate Commit Message
        if: github.event_name == 'pull_request_review' && steps.branch-validation.outputs.is_approved == 'true' && steps.branch-validation.outputs.valid == 'valid'
        id: generate-commit-message
        run: |
          BRANCH_USER="${{ steps.branch-validation.outputs.branch_user }}"
          WEEK_NUMBER="${{ steps.branch-validation.outputs.week_number }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          COMMIT_MSG="docs: Update README for week-${WEEK_NUMBER} by ${BRANCH_USER} (PR #${PR_NUMBER})"
          echo "commit_message=$COMMIT_MSG" >> $GITHUB_OUTPUT

      - name: Commit and Push README.md
        if: github.event_name == 'pull_request_review' && steps.branch-validation.outputs.is_approved == 'true' && steps.branch-validation.outputs.valid == 'valid'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: ${{ steps.generate-commit-message.outputs.commit_message }}
          branch: main
          commit_user_name: GitHub Action Bot
          commit_user_email: action@github.com
          file_pattern: README.md

      - name: Post Approve Success Comment
        if: github.event_name == 'pull_request_review' && steps.branch-validation.outputs.is_approved == 'true' && steps.branch-validation.outputs.valid == 'valid'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branchUser = '${{ steps.branch-validation.outputs.branch_user }}';
            const isOwner = '${{ steps.branch-validation.outputs.is_owner }}' === 'true';
            
            let commentBody = `## ğŸ‰ README ì—…ë°ì´íŠ¸ ì™„ë£Œ!\n\n`;
            
            if (isOwner) {
              commentBody += `ğŸ‘‘ **ì €ì¥ì†Œ ì†Œìœ ì(${branchUser})ì˜ ì œì¶œì´ ìŠ¹ì¸ë˜ì–´ ì›ë³¸ ì €ì¥ì†Œì˜ READMEê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.**\n\n`;
            } else {
              commentBody += `âœ… **${branchUser}ë‹˜ì˜ ì œì¶œì´ ìŠ¹ì¸ë˜ì–´ ì›ë³¸ ì €ì¥ì†Œì˜ READMEê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.**\n\n`;
            }
            
            commentBody += `ì´ì œ ì´ PRì„ ì•ˆì „í•˜ê²Œ ë¨¸ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤! ğŸš€`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });

      - name: Send Mattermost DM Notification
        if: github.event_name == 'pull_request_target' && steps.branch-validation.outputs.valid == 'valid' && always() && steps.pr-test.outcome != 'skipped'
        env:
          PERSONAL_WEBHOOK_URL: ${{ secrets[format('{0}_MATTERMOST_URL', steps.branch-validation.outputs.branch_user)] }}
          BRANCH_USER: ${{ steps.branch-validation.outputs.branch_user }}
          OVERALL_RESULT: ${{ steps.analyze-results.outputs.overall_result }}
        run: |
          if [ -n "$PERSONAL_WEBHOOK_URL" ]; then
            if [ "$OVERALL_RESULT" = "PASS" ]; then
              python scripts/send_success_notification.py "${{ github.event.pull_request.html_url }}" "$BRANCH_USER" "$PERSONAL_WEBHOOK_URL"
            else
              python scripts/send_failure_notification.py "${{ github.event.pull_request.html_url }}" "$BRANCH_USER" "$PERSONAL_WEBHOOK_URL"
            fi
          else
            echo "âš ï¸ $BRANCH_USER ë‹˜ì˜ Mattermost ì›¹í›… URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          fi
      
      # =================================================================
      #  ì£¼ê°„ ì‹¤í–‰ ë¡œì§
      # =================================================================
      - name: Checkout main branch for weekly reset
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        uses: actions/checkout@v4
        with:
          ref: 'main'
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Weekly Logic - Reset README for New Week
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: |
          echo "ğŸ“… ìƒˆë¡œìš´ ì£¼ì°¨ë¥¼ ìœ„í•´ READMEë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤."
          python scripts/weekly_reset.py --force

      - name: Commit and Push Weekly Reset
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: Reset README for the new week"
          branch: main
          commit_user_name: GitHub Action Bot
          commit_user_email: action@github.com
          file_pattern: README.md
