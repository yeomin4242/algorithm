# PR ë¨¸ì§€ í›„ README ì—…ë°ì´íŠ¸ ì›Œí¬í”Œë¡œìš°
name: Post-Merge README Update

on:
  pull_request:
    types: [closed]
    branches: [main]

permissions:
  contents: write
  pull-requests: read

env:
  TZ: Asia/Seoul
  REPO_OWNER: "yeomin4242"

jobs:
  post-merge-update:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Post-Merge Workflow Info
        run: |
          echo "ğŸ‰ PR ë¨¸ì§€ í›„ README ì—…ë°ì´íŠ¸ ì›Œí¬í”Œë¡œìš° ì‹œì‘"
          echo "â° ì‹¤í–‰ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S KST')"
          echo "ğŸ“‹ ë¨¸ì§€ëœ PR: #${{ github.event.pull_request.number }}"
          echo "ğŸ‘¤ PR ì‘ì„±ì: ${{ github.event.pull_request.user.login }}"
          echo "ğŸŒ¿ ë¨¸ì§€ëœ ë¸Œëœì¹˜: ${{ github.event.pull_request.head.ref }}"

      - name: Validate and Parse Merged Branch
        id: branch-info
        run: |
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          AUTHOR="${{ github.event.pull_request.user.login }}"
          HEAD_REPO="${{ github.event.pull_request.head.repo.full_name }}"
          BASE_REPO="${{ github.repository }}"
          REPO_OWNER="${{ env.REPO_OWNER }}"
          
          echo "ğŸ” ë¨¸ì§€ëœ ë¸Œëœì¹˜ ì •ë³´ ë¶„ì„"
          echo "ğŸ“‚ Head Repository: $HEAD_REPO"
          echo "ğŸ“‚ Base Repository: $BASE_REPO"
          echo "ğŸŒ¿ ë¸Œëœì¹˜: $BRANCH_NAME"
          echo "ğŸ‘¤ PR ì‘ì„±ì: $AUTHOR"
          
          # í¬í¬ ì—¬ë¶€ í™•ì¸
          if [ "$HEAD_REPO" != "$BASE_REPO" ]; then
            echo "ğŸ”€ í¬í¬ëœ ì €ì¥ì†Œì—ì„œì˜ PRì´ ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤."
            IS_FORK="true"
          else
            echo "ğŸ“ ì›ë³¸ ì €ì¥ì†Œì—ì„œì˜ PRì´ ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤."
            IS_FORK="false"
          fi
          
          # ì €ì¥ì†Œ ì†Œìœ ìì¸ì§€ í™•ì¸
          if [ "$AUTHOR" = "$REPO_OWNER" ]; then
            echo "ğŸ‘‘ ì €ì¥ì†Œ ì†Œìœ ìì˜ PRì´ ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤."
            IS_OWNER="true"
            SHOULD_UPDATE="true"
            WEEK_NUMBER="owner"
            BRANCH_USER="$AUTHOR"
          else
            echo "ğŸ‘¤ ì¼ë°˜ ì‚¬ìš©ìì˜ PRì´ ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤."
            IS_OWNER="false"
            
            # week-N-<githubID> íŒ¨í„´ ê²€ì¦
            if [[ $BRANCH_NAME =~ ^week-([0-9]+)-(.+)$ ]]; then
              WEEK_NUMBER="${BASH_REMATCH[1]}"
              BRANCH_USER="${BASH_REMATCH[2]}"
              
              echo "âœ… ì•Œê³ ë¦¬ì¦˜ ìŠ¤í„°ë”” ë¸Œëœì¹˜ì…ë‹ˆë‹¤."
              echo "ğŸ“… ì£¼ì°¨: $WEEK_NUMBER"
              echo "ğŸ‘¤ ë¸Œëœì¹˜ ì‚¬ìš©ì: $BRANCH_USER"
              
              SHOULD_UPDATE="true"
            else
              echo "â„¹ï¸ ì•Œê³ ë¦¬ì¦˜ ìŠ¤í„°ë”” ë¸Œëœì¹˜ê°€ ì•„ë‹™ë‹ˆë‹¤. README ì—…ë°ì´íŠ¸ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
              SHOULD_UPDATE="false"
            fi
          fi
          
          echo "should_update=$SHOULD_UPDATE" >> $GITHUB_OUTPUT
          echo "week_number=$WEEK_NUMBER" >> $GITHUB_OUTPUT
          echo "branch_user=$BRANCH_USER" >> $GITHUB_OUTPUT
          echo "is_fork=$IS_FORK" >> $GITHUB_OUTPUT
          echo "is_owner=$IS_OWNER" >> $GITHUB_OUTPUT

      - name: Checkout Main Branch
        if: steps.branch-info.outputs.should_update == 'true'
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main
          fetch-depth: 0

      - name: Setup Python
        if: steps.branch-info.outputs.should_update == 'true'
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        if: steps.branch-info.outputs.should_update == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install google-genai pytz requests beautifulsoup4

      - name: Analyze Merged PR and Update README
        if: steps.branch-info.outputs.should_update == 'true'
        env:
          WEEK_NUMBER: ${{ steps.branch-info.outputs.week_number }}
          BRANCH_USER: ${{ steps.branch-info.outputs.branch_user }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          IS_FORK: ${{ steps.branch-info.outputs.is_fork }}
          IS_OWNER: ${{ steps.branch-info.outputs.is_owner }}
        run: |
          if [ "$IS_OWNER" = "true" ]; then
            echo "ğŸ“ ì €ì¥ì†Œ ì†Œìœ ìì˜ ë¨¸ì§€ëœ PRì— ëŒ€í•´ README ì—…ë°ì´íŠ¸ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤."
          else
            echo "ğŸ“ Week $WEEK_NUMBER - $BRANCH_USERë‹˜ì˜ ë¨¸ì§€ëœ PRì— ëŒ€í•´ README ì—…ë°ì´íŠ¸ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤."
          fi
          echo "ğŸ”— PR ë²ˆí˜¸: $PR_NUMBER"
          echo "ğŸ”€ í¬í¬ ì—¬ë¶€: $IS_FORK"
          
          # PRì—ì„œ ë³€ê²½ëœ íŒŒì¼ë“¤ì„ ë¶„ì„í•˜ì—¬ ì œì¶œëœ ë¬¸ì œ íŒŒì•…
          echo "ğŸ” ë¨¸ì§€ëœ PRì˜ ë³€ê²½ì‚¬í•­ì„ ë¶„ì„í•©ë‹ˆë‹¤..."
          
          # GitHub APIë¥¼ ì‚¬ìš©í•˜ì—¬ PRì˜ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/vnd.github.v3+json" \
               "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/files" \
               > pr_files.json
          
          # ë¨¸ì§€ëœ PR ë¶„ì„ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          python scripts/analyze_merged_pr.py
          
          # README ì—…ë°ì´íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          if [ -f "problems_info.json" ]; then
            echo "âœ… ì œì¶œëœ ë¬¸ì œ ì •ë³´ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤."
            python scripts/update_readme_batch.py
          else
            echo "â„¹ï¸ ì œì¶œëœ ì•Œê³ ë¦¬ì¦˜ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤."
          fi

      - name: Commit README Changes
        if: steps.branch-info.outputs.should_update == 'true'
        env:
          WEEK_NUMBER: ${{ steps.branch-info.outputs.week_number }}
          BRANCH_USER: ${{ steps.branch-info.outputs.branch_user }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          IS_OWNER: ${{ steps.branch-info.outputs.is_owner }}
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"
          
          if ! git diff --quiet README.md; then
            echo "ğŸ“‹ README.md ë³€ê²½ì‚¬í•­ì„ ì»¤ë°‹í•©ë‹ˆë‹¤."
            
            # ì»¤ë°‹ ë©”ì‹œì§€ êµ¬ì„±
            if [ "$IS_OWNER" = "true" ]; then
              COMMIT_MSG="docs: Update README.md after merging owner's solution (PR #$PR_NUMBER)"
            else
              COMMIT_MSG="docs: Update README.md after merging week-$WEEK_NUMBER solution by $BRANCH_USER (PR #$PR_NUMBER)"
            fi
            
            git add README.md
            git commit -m "$COMMIT_MSG"
            git push origin main
            echo "âœ… README ì—…ë°ì´íŠ¸ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
          else
            echo "â„¹ï¸ README.mdì— ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
          fi

      - name: Send Merge Completion Notification
        if: steps.branch-info.outputs.should_update == 'true'
        env:
          PERSONAL_WEBHOOK_URL: ${{ secrets[format('{0}_MATTERMOST_URL', steps.branch-info.outputs.branch_user)] }}
          WEEK_NUMBER: ${{ steps.branch-info.outputs.week_number }}
          BRANCH_USER: ${{ steps.branch-info.outputs.branch_user }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          IS_OWNER: ${{ steps.branch-info.outputs.is_owner }}
        run: |
          if [ -n "$PERSONAL_WEBHOOK_URL" ]; then
            if [ "$IS_OWNER" = "true" ]; then
              echo "ğŸ‰ ì €ì¥ì†Œ ì†Œìœ ìì˜ ì†”ë£¨ì…˜ì´ ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤! ì•Œë¦¼ì„ ì „ì†¡í•©ë‹ˆë‹¤."
            else
              echo "ğŸ‰ Week $WEEK_NUMBER - $BRANCH_USERë‹˜ì˜ ì†”ë£¨ì…˜ì´ ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤! ì•Œë¦¼ì„ ì „ì†¡í•©ë‹ˆë‹¤."
            fi
            
            # ë¨¸ì§€ ì™„ë£Œ ì•Œë¦¼ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
            python scripts/send_merge_notification.py \
              "${{ github.event.pull_request.html_url }}" \
              "$BRANCH_USER" \
              "$WEEK_NUMBER" \
              "$PERSONAL_WEBHOOK_URL"
          else
            echo "âš ï¸ $BRANCH_USERë‹˜ì˜ Mattermost ì›¹í›… URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
            echo "ğŸ’¡ ì‹œí¬ë¦¿ ì´ë¦„: ${BRANCH_USER}_MATTERMOST_URL"
          fi