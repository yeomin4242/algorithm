# í¬í¬ëœ ì €ì¥ì†Œ PR ìë™ ìŠ¹ì¸ ì›Œí¬í”Œë¡œìš°
name: Auto Approve Fork PRs

on:
  pull_request_target:
    types: [opened, synchronize, reopened]
    branches: [main]

permissions:
  pull-requests: write
  actions: write

jobs:
  auto-approve:
    # í¬í¬ëœ ì €ì¥ì†Œì—ì„œë§Œ ì‹¤í–‰
    if: github.event.pull_request.head.repo.full_name != github.repository
    runs-on: ubuntu-latest
    steps:
      - name: Validate Fork PR
        id: validate
        run: |
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          AUTHOR="${{ github.event.pull_request.user.login }}"
          
          echo "ğŸ” í¬í¬ PR ê²€ì¦: $BRANCH_NAME by $AUTHOR"
          
          # ì•Œê³ ë¦¬ì¦˜ ìŠ¤í„°ë”” ë¸Œëœì¹˜ íŒ¨í„´ í™•ì¸
          if [[ $BRANCH_NAME =~ ^week-([0-9]+)-(.+)$ ]]; then
            WEEK_NUMBER="${BASH_REMATCH[1]}"
            BRANCH_USER="${BASH_REMATCH[2]}"
            
            if [ "$BRANCH_USER" = "$AUTHOR" ]; then
              echo "âœ… ìœ íš¨í•œ ì•Œê³ ë¦¬ì¦˜ ìŠ¤í„°ë”” PRì…ë‹ˆë‹¤."
              echo "should_approve=true" >> $GITHUB_OUTPUT
            else
              echo "âŒ ë¸Œëœì¹˜ ì‚¬ìš©ìì™€ PR ì‘ì„±ìê°€ ë‹¤ë¦…ë‹ˆë‹¤."
              echo "should_approve=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "â„¹ï¸ ì•Œê³ ë¦¬ì¦˜ ìŠ¤í„°ë”” ë¸Œëœì¹˜ê°€ ì•„ë‹™ë‹ˆë‹¤."
            echo "should_approve=false" >> $GITHUB_OUTPUT
          fi

      - name: Auto Approve Valid Fork PRs
        if: steps.validate.outputs.should_approve == 'true'
        uses: hmarr/auto-approve-action@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          review-message: |
            ğŸ¤– **ìë™ ìŠ¹ì¸ëœ í¬í¬ PR**
            
            âœ… ì´ PRì€ ì˜¬ë°”ë¥¸ ë¸Œëœì¹˜ íŒ¨í„´(`week-N-<githubID>`)ì„ ë”°ë¥´ëŠ” ì•Œê³ ë¦¬ì¦˜ ìŠ¤í„°ë”” ì œì¶œì…ë‹ˆë‹¤.
            ğŸš€ GitHub Actions ì›Œí¬í”Œë¡œìš°ê°€ ìë™ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤.
            
            **ì œì¶œ ì •ë³´:**
            - ë¸Œëœì¹˜: `${{ github.event.pull_request.head.ref }}`
            - ì œì¶œì: `${{ github.event.pull_request.user.login }}`
            - í¬í¬ ì €ì¥ì†Œ: `${{ github.event.pull_request.head.repo.full_name }}`

      - name: Comment on Invalid Fork PRs
        if: steps.validate.outputs.should_approve == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branchName = '${{ github.event.pull_request.head.ref }}';
            const author = '${{ github.event.pull_request.user.login }}';
            
            let commentBody = `## ğŸš« í¬í¬ PR ìë™ ìŠ¹ì¸ ë¶ˆê°€\n\n`;
            commentBody += `í˜„ì¬ ë¸Œëœì¹˜: \`${branchName}\`\n`;
            commentBody += `PR ì‘ì„±ì: \`${author}\`\n\n`;
            commentBody += `âŒ ì´ PRì€ ìë™ ìŠ¹ì¸ ì¡°ê±´ì„ ë§Œì¡±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n\n`;
            commentBody += `### ğŸ“ ìë™ ìŠ¹ì¸ ì¡°ê±´\n`;
            commentBody += `1. ë¸Œëœì¹˜ íŒ¨í„´: \`week-N-<githubID>\`\n`;
            commentBody += `2. ë¸Œëœì¹˜ì˜ GitHub IDì™€ PR ì‘ì„±ì ì¼ì¹˜\n\n`;
            commentBody += `### âœ… ì˜¬ë°”ë¥¸ ì˜ˆì‹œ\n`;
            commentBody += `- \`week-1-${author}\`\n`;
            commentBody += `- \`week-2-${author}\`\n\n`;
            commentBody += `âš ï¸ **ìˆ˜ë™ ìŠ¹ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.** ì €ì¥ì†Œ ê´€ë¦¬ìê°€ ê²€í†  í›„ ìŠ¹ì¸í•´ì£¼ì„¸ìš”.`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });